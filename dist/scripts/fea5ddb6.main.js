"use strict";function help_url(a,b){return"https://docs.project-fifo.net/jingles/"+a+".html#"+b}function MetricSeries(a){for(var b,c=a.scale||1,d=a.size||30,e=a.type||"progressive",f=[],g=[],h=0;d>h;h++)f[h]=0,g[h]=0;this.add=function(a){switch(f.shift(),f.push(a),e){case"progressive":b&&(g.shift(),g.push((a-b)/c));break;case"absolute":g.shift(),g.push(a/c)}b=a},this.data_points=function(){return g.map(function(a,b){return[b-d,a]})}}function MetricsGraph(a,b){var c,d=(b.unit||"",b.series||[]),e=document.getElementById(a),f=d.map(function(a){return a.size=b.size,new MetricSeries(a)}),g=function(){if($(e).is(":visible")){var a=f.map(function(a){return a.data_points()});if("percentage"==b.type)for(var g=0;g<b.size;g++){var h=0;a.forEach(function(a){h+=a[g][1]}),h>0&&(a=a.map(function(a){return a[g][1]=100*(a[g][1]/h),a}))}a=a.map(function(a,b){var c={};return d[b].options&&(c=d[b].options),c.data=a,c});var i={HtmlText:!1,yaxis:{titleAngle:90},legend:{position:"nw"}};b.unit&&(i.yaxis.title=b.unit),b.min&&(i.yaxis.min=b.min),b.max&&(i.yaxis.max=b.max),c=Flotr.draw(e,a,i)}};this.add=function(a){a.forEach(function(a,b){f[b].add(a)}),g()}}function mk_permission_fn(a,b){return function(c){switch(delete b.permission,c){case 3:b.show_text="ssh"==b.perm3?!0:!1,b.permission={controller_id:b.perm1,controller_id1:b.perm2,controller_id2:b.perm3};break;case 1:switch(b.show_text=!1,b.p2=!1,b.p3=!1,b.perm2="",b.perm3="",b.perm1){case"...":b.permission={controller_id:"..."};break;case"cloud":b.p2={cloud:{id:"cloud",name:"Cloud"},datasets:{id:"datasets",name:"Datasets"},dtraces:{id:"dtraces",name:"DTrace"},roles:{id:"roles",name:"Roles"},hypervisors:{id:"hypervisors",name:"Hypervisors"},ipranges:{id:"ipranges",name:"IP Ranges"},networks:{id:"networks",name:"Networks"},orgs:{id:"orgs",name:"Organizations"},packages:{id:"packages",name:"Packages"},users:{id:"users",name:"Users"},vms:{id:"vms",name:"Virtual Machines"}};break;case"channels":b.p2={},a.hypervisors.query(function(a){a.forEach(function(a){b.p2[a.uuid]={id:a.uuid,name:"Server "+a.alias}})}),a.vms.query(function(a){a.forEach(function(a){b.p2[a.uuid]={id:a.uuid,name:"Machine "+a.config.alias}})});break;case"dtraces":a.dtrace.query(function(a){a.length>0&&(b.p2={"...":{id:"...",name:"Everything"},_:{id:"_",name:"All Dtraces"}}),a.forEach(function(a){b.p2[a.uuid]={id:a.uuid,name:a.name}})});break;case"users":a.users.query(function(a){a.length>0&&(b.p2={"...":{id:"...",name:"Everything"},_:{id:"_",name:"All Users"}}),a.forEach(function(a){b.p2[a.uuid]={id:a.uuid,name:a.name}})});break;case"orgs":a.orgs.query(function(a){b.p2={"...":{id:"...",name:"Everything"},_:{id:"_",name:"All Orgs"}},a.forEach(function(a){b.p2[a.uuid]={id:a.uuid,name:a.name}})});break;case"roles":a.roles.query(function(a){a.length>0&&(b.p2={"...":{id:"...",name:"Everything"},_:{id:"_",name:"All Roles"}}),a.forEach(function(a){b.p2[a.uuid]={id:a.uuid,name:a.name}})});break;case"hypervisors":a.hypervisors.query(function(a){a.length>0&&(b.p2={"...":{id:"...",name:"Everything"},_:{id:"_",name:"All Hypervisors"}}),a.forEach(function(a){b.p2[a.uuid]={id:a.uuid,name:a.alias}})});break;case"vms":a.vms.query(function(a){a.length>0&&(b.p2={"...":{id:"...",name:"Everything"},_:{id:"_",name:"All Virtual Machines"}}),a.forEach(function(a){b.p2[a.uuid]={id:a.uuid};var c=a.uuid;a.config&&a.config.alias&&(c=c+" ("+a.config.alias+")"),b.p2[a.uuid].name=c})});break;case"datasets":a.datasets.query(function(a){a.length>0&&(b.p2={"...":{id:"...",name:"Everything"},_:{id:"_",name:"All Datasets"}}),a.forEach(function(a){b.p2[a.dataset]={id:a.dataset,name:a.name+" "+a.version}})});break;case"packages":a.packages.query(function(a){a.length>0&&(b.p2={"...":{id:"...",name:"Everything"},_:{id:"_",name:"All Packages"}}),a.forEach(function(a){b.p2[a.uuid]={id:a.uuid,name:a.name+" ("+a.uuid+")"}})});break;case"ipranges":a.ipranges.query(function(a){a.length>0&&(b.p2={"...":{id:"...",name:"Everything"},_:{id:"_",name:"All Networks"}}),a.forEach(function(a){b.p2[a.uuid]={id:a.uuid,name:a.name+" ("+a.uuid+")"}})});break;case"networks":a.networks.query(function(a){a.length>0&&(b.p2={"...":{id:"...",name:"Everything"},_:{id:"_",name:"All Networks"}}),a.forEach(function(a){b.p2[a.uuid]={id:a.uuid,name:a.name+" ("+a.uuid+")"}})})}break;case 2:if(b.show_text=!1,b.p3=!1,b.perm3="","..."==b.perm2)b.permission={controller_id:b.perm1,controller_id1:"..."};else{switch(b.perm1){case"cloud":switch(b.perm2){case"cloud":b.p3=[{id:"status",name:"Status"}];break;case"vms":b.p3=[{id:"list",name:"List"},{id:"create",name:"Create"},{id:"advanced_create",name:"Advanced Create"}];break;case"users":case"roles":case"packages":case"dtraces":case"ipranges":case"networks":case"orgs":b.p3=[{id:"list",name:"List"},{id:"create",name:"Create"}];break;case"datasets":b.p3=[{id:"list",name:"List"},{id:"import",name:"Import"}];break;case"hypervisors":b.p3=[{id:"list",name:"List"}]}break;case"users":b.p3=[{id:"get",name:"See"},{id:"passwd",name:"Change Password"},{id:"delete",name:"Delete"},{id:"grant",name:"Grant a Permission"},{id:"revoke",name:"Revoke a Permission"},{id:"join",name:"Join a role"},{id:"leave",name:"Leave a role"}];break;case"orgs":b.p3=[{id:"list",name:"List"},{id:"get",name:"See"},{id:"edit",name:"Edit"},{id:"delete",name:"Delete"},{id:"create",name:"Create"}];break;case"roles":b.p3=[{id:"get",name:"See"},{id:"delete",name:"Delete"},{id:"grant",name:"Grant a Permission"},{id:"revoke",name:"Revoke a Permission"},{id:"join",name:"Join this role"},{id:"leave",name:"Leave this role"}];break;case"channels":b.p3=[{id:"join",name:"Join"},{id:"leave",name:"Leave"}];break;case"vms":b.p3=[{id:"get",name:"See"},{id:"state",name:"State"},{id:"delete",name:"Delete"},{id:"console",name:"Console/VNC"},{id:"snapshot",name:"Create a Snapshot"},{id:"rollback",name:"Rollback a Snapshot"},{id:"edit",name:"Edit"},{id:"snapshot_delete",name:"Delete a Snapshot"},{id:"ssh",name:"SSH Login"}];break;case"dtraces":b.p3=[{id:"get",name:"See"},{id:"create",name:"Create VM's here"},{id:"edit",name:"Edit"},{id:"stream",name:"Stream"},{id:"delete",name:"Delete"}];break;case"hypervisors":b.p3=[{id:"get",name:"See"},{id:"create",name:"Create VM's here"},{id:"edit",name:"Edit Metadata"}];break;case"networks":case"ipranges":case"packages":case"datasets":b.p3=[{id:"get",name:"See"},{id:"delete",name:"Delete"},{id:"edit",name:"Edit"},{id:"create",name:"Create"}]}b.p3&&b.p3.unshift({id:"...",name:"Everything"})}}}}function init_scope(a,b){a.org=b,a.grant_triggers={},a.join_triggers={};var c=b.triggers||{};for(var d in c){if(!c.hasOwnProperty(d))return;var e=c[d],f=e.action;e.uuid=d,"role_grant"==f||"user_grant"==f?a.grant_triggers[d]=e:("join_org"==f||"join_role"==f)&&(a.join_triggers[d]=e)}return a}function Heatmap(a,b){console.log("New heatmap renderer:",b),this.target=a,this.config=b,this.h=7,this.w=20,this.cols=[],this.history_size=20,void 0!=b.history_size&&(this.history_size=b.history_size),this.bucket_count=32,void 0!=b.end&&void 0!=b.start&&void 0!=b.step&&(this.bucket_count=(b.end-b.start+1)/b.step),this.bucket_size=2,void 0!=b.step&&(this.bucket_size=b.step||2);for(var c=0;c<this.history_size;c++)this.cols.push([]);d3.select(this.target).attr("style","background: white;"),this.play=!0}var wait={forUserLogin:["auth",function(a){return a.userPromise()}]};angular.module("fifoApp",["ngRoute","ngAnimate","ngResource","services.breadcrumbs","gettext","infinite-scroll","ngTable","angularMoment","ngSanitize","ngCookies","angularFileUpload"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",helpUrl:help_url("general","dashboard"),resolve:wait}).when("/machines",{templateUrl:"views/machines.html",controller:"MachinesCtrl",helpUrl:help_url("machines","list"),name:"Machines",resolve:wait}).when("/datasets",{templateUrl:"views/datasets.html",controller:"DatasetsCtrl",helpUrl:help_url("datasets","installed"),name:"Datasets"}).when("/servers",{templateUrl:"views/servers.html",controller:"ServersCtrl",helpUrl:help_url("hypervisors","list"),name:"Servers"}).when("/configuration/networks/new",{templateUrl:"views/network-new.html",controller:"NetworkNewCtrl",helpUrl:help_url("network","new")}).when("/machines/new",{templateUrl:"views/machine-new.html",controller:"MachineNewCtrl",helpUrl:help_url("machines","new")}).when("/machines/:uuid",{templateUrl:"views/machine.html",controller:"MachineCtrl",helpUrl:help_url("machines","details")}).when("/datasets/:uuid",{templateUrl:"views/dataset.html",helpUrl:help_url("datasets","details"),controller:"DatasetCtrl"}).when("/servers/:uuid",{templateUrl:"views/server.html",helpUrl:help_url("hypervisors","details"),controller:"ServerCtrl"}).when("/configuration/packages/new",{templateUrl:"views/package-new.html",helpUrl:help_url("packages","new"),controller:"PackageNewCtrl"}).when("/configuration/packages/:uuid",{templateUrl:"views/package.html",helpUrl:help_url("packages","details"),controller:"PackageCtrl"}).when("/configuration/networks/:uuid",{templateUrl:"views/network.html",helpUrl:help_url("network","details"),controller:"NetworkCtrl"}).when("/configuration/users/new",{templateUrl:"views/user-new.html",helpUrl:help_url("usermanagement","user-new"),controller:"UserNewCtrl"}).when("/configuration/users/:uuid",{templateUrl:"views/user.html",controller:"UserCtrl",helpUrl:help_url("usermanagement","user-details")}).when("/about",{templateUrl:"views/about.html",helpUrl:help_url("general","about"),controller:"AboutCtrl"}).when("/configuration/roles/new",{templateUrl:"views/role-new.html",helpUrl:help_url("usermanagement","role-new"),controller:"RoleNewCtrl"}).when("/configuration/roles/:uuid",{templateUrl:"views/role.html",helpUrl:help_url("usermanagement","role-details"),controller:"RoleCtrl"}).when("/configuration/organizations/new",{templateUrl:"views/organization-new.html",helpUrl:help_url("orgs","create"),controller:"OrganizationNewCtrl"}).when("/configuration/organizations/:uuid",{templateUrl:"views/organization.html",helpUrl:help_url("orgs","details"),controller:"OrganizationCtrl"}).when("/configuration/dtraces/new",{templateUrl:"views/dtrace-new.html",helpUrl:help_url("dtraces","new"),controller:"DtraceNewCtrl"}).when("/configuration/dtraces/:uuid",{templateUrl:"views/dtrace.html",helpUrl:help_url("dtraces","details"),controller:"DtraceCtrl"}).when("/login",{templateUrl:"views/login.html",helpUrl:help_url("general","login"),controller:"LoginCtrl"}).when("/configuration/ip-ranges/new",{templateUrl:"views/ip-range-new.html",helpUrl:help_url("ipranges","new"),controller:"IpRangeNewCtrl"}).when("/visualizations/graph",{templateUrl:"views/vis-graph.html",helpUrl:help_url("general","cloudview"),controller:"VisGraphCtrl"}).when("/configuration/users",{redirectTo:"/configuration/users_roles"}).when("/configuration/groups",{redirectTo:"/configuration/users_roles"}).when("/configuration/networks",{redirectTo:"/configuration/networking"}).when("/configuration/ip-ranges",{redirectTo:"/configuration/networking"}).when("/configuration/:target?",{templateUrl:"views/configurations.html",controller:"ConfigurationCtrl",helpUrl:help_url("configuration","list")}).otherwise({redirectTo:"/"})}]).run(["$rootScope","gettextCatalog","gettext","$window","$templateCache","$interval","wiggle",function(a,b,c,d,e,f,g){function h(){g.cloud.get(function(b){angular.forEach(b.warnings,function(a){switch(a.category){case"chunter":a.link="#/servers/"+a.element}}),a.cloudStatus.metrics=b.metrics,a.cloudStatus.messages=Config.evaluate_cloud(b.metrics).concat(b.warnings),a.cloudStatus.no_servers=!b.metrics.hypervisors||b.metrics.hypervisors.length<1,a.cloudStatus.cloud_ok=a.cloudStatus.messages.filter(function(a){return a.ok=!!a.ok,!a.ok}).length<1,a.cloudStatus.no_servers&&(a.cloudStatus.cloud_ok=!1)},function(a){console.error("Cloud status error:",a)})}e.put("ng-table/pager.html","");var i=window.navigator.userLanguage||window.navigator.language;i.indexOf("-")>-1&&(i=i.split("-")[0]),Object.keys(b.strings).indexOf(i)<0&&(i="gb"),b.currentLanguage=i;var j=function(){function a(a){a.preventDefault()}$("[data-toggle=tab]").on("click",a),$("[data-toggle=collapse]").on("click",a)};a.$on("$routeChangeSuccess",function(){setTimeout(j,0)}),a.cloudStatus={},a.$on("auth:login_ok",function(){f(h,1e3*(Config.statusPolling||10)),h()})}]),angular.module("fifoApp").config(["$logProvider",function(a){a.debugEnabled(!1)}]),angular.module("gettext").run(["gettextCatalog",function(a){a.setStrings("es",{About:"Acerca de",Actions:"Acciones","Active Organisation":"Organización activa",Add:"Agregar","Add Network Interface":"Nueva interfaz de red","Add trigger":"Agregar trigger","Advanced rules":"Reglas avanzadas","Agent ver":"ver. Agente","Agent version":"Versión agente",Alias:"Nombre",Autoboot:"","Automatic grants on creation":"","Automatic joins on user creation":"",Backup:"",Booted:"Buteado",CPU:"CPU","CPU / Mainboard":"CPU / Placa","CPU Cap":"CPU Cap","CPU Load":"Carga de CPU","CPU Usage":"Uso de CPU","CPU type":"Tipo de CPU",Capabilities:"Capacidades",Capability:"Capacidad",Category:"categoria",Change:"Cambiar","Change Password":"Cambiar clave","Change to":"Cambiar a",Channels:"Canales",Characteristics:"Características",Charge:"Carga",Cloud:"Nube","Cloud View":"Vision nube",Config:"Config","Console/VNC":"Consola/VNC",Cores:"Núcleos",Create:"Crear","Create a":"Crear una","Create a Snapshot":"Crear un Snapshot","Create a iprange called:":"Crear un nuevo rango que se llame:","Create a package called":"Crear un paquete que se llame",Created:"Creado",Creator:"Creador","Current package":"Paquete actual",DTrace:"",Dataset:"",Datasets:"Datasets",Delete:"Borrar","Delete a Snapshot":"Borrar un snapshot",Describe:"Descripción",Description:"Descripción",Details:"Detalles",Disk:"Disco","Disk IOPS":"IO/s disco","Disk Throughput":"Uso disco","Disk usage":"Uso de disco",Disks:"Discos",Distance:"Discantia",Edit:"Editar",Element:"Elemento",Everything:"Todo","FiFo Home":"FiFo Home",Filter:"Filtro",First:"Primero",Force:"Forzar",Form:"Formulario",Free:"Libre","Full Screen":"Pantalla completa",Gateway:"Puerta enlace",Grant:"Autorizar",Role:"Grupo",Roles:"Grupos",Help:"Ayuda",History:"Historial",Hostname:"",Hypervisors:"Hypervisores",ID:"ID",IP:"IP","IP Ranges":"Rangos de IP",IPv4:"",Imaging:"",Import:"Importar",Imported:"Importado",Info:"Info",Information:"Información",Installed:"Instalado",Iprange:"rango IP",Join:"Unir",Key:"Llave","Key ID":"ID llave","L1 Arc hit %":"","L1 Size":"Tamaño L1","L2 Arc hit %":"","L2 Size":"Tamaño L2",Last:"Ultimo","List Color":"Color",Loading:"Cargando",Logout:"Salir",Mac:"",Machine:"Máquina",Machines:"Máquinas","Main IP":"IP principal",Mainboard:"Placa",Manufacturer:"Fabricante",Memory:"Memoria","Memory Usage":"Uso memoria",Message:"Mensaje",Messages:"Mensajes",Model:"Modelo","My info":"Mi info",NIC:"",Name:"Nombre",Netmask:"Máscara",Network:"Red","Network tags":"Tags de red",Networking:"Red",Networks:"Redes","New Role":"Nuevo grupo","New IP Range":"Nuevo rango de IP","New Machine":"Nueva máquina","New Network":"Nueva red","New Organization":"Nueva organización","New Package":"Nuevo paquete","New Trace":"Nueva traza","New User":"Nuevo usuario",Next:"Siguiente",'No ssh keys found on your account. Dont forget to <a href="#/configuration/users/{{user.uuid}}">add one</a>!':"No tienes ninguna llave ssh, no te olvides de <a href=\\”#/configuration/users/{{user.uuid}}\\”>agregar</a> una!","Node name":"Nombre del nodo",Notes:"Notas",OS:"S.O.","Org/Role":"Organizaciones y grupos",Organization:"Organización",Organizations:"Organizaciones",Owner:"Dueño",Package:"Paquete",Packages:"Paquetes",Parameters:"Parámetros",Passwords:"Claves",Performance:"",Permission:"Permisos",Permissions:"Permisos","Please identify yourself":"Favor, identifícate",Pool:"","Project FiFo":"Project FiFo",Provisioned:"Provisionado",Published:"Publicado",Ram:"",Reboot:"Reiniciar","Remote datasets":"Datasets remotos",Reset:"Resetear","Resolver 1":"","Resolver 2":"",Resolvers:"",Resources:"Recursos",Returned:"Retornados","Rollback a Snapshot":"Devolverse al snapshot",Rules:"Reglas",Run:"Ejecutar","SSH Keys":"Llaves SSH","SSH Keys will be used when creating new KVM machines. They also will dynamically grant access              to SmartOS zones. Based on the console access to the zone.":"Las llaves SSH se usan a momento de crear nuevas máquinas KVM y también para autorizar dinámicamente a las zonas.","SSH keys configured: {{keys}}":"Llaves SSH configuradas: {{keys}}",Save:"Guardar",Script:"Script",Scripts:"",See:"Ver",Serial:"",Server:"Servidor",Servers:"Servidores",Services:"Servicios",Showing:"Mostrando",Size:"Tamaño","SmartOS ver":"Versión SmartOS",Snapshot:"Snapshot",Snapshots:"","Something is wrong with this machine.":"Hay algo malo con esta máquina",Start:"Iniciar",Status:"",Stop:"Detener",Storage:"","Swap Usage":"Uso de swap",Tag:"",Template:"","The Team":"El equipo","Tip: You can <a href=\"http://project-fifo.net/display/PF/LeoFS\">configure</a> Fifo to backup machine's into an S3 compatible service. Then, you will see a 'Versioning' tab on each machine page that lets you work with the backups.":"Tip: You can <a href=\\”http://project-fifo.net/display/PF/LeoFS\\”>configure</a> Fifo to backup machine’s into an S3 compatible service. Then, you will see a ‘Versioning’ tab on each machine page that lets you work with the backups.","To rollback, please stop the machine":"Para hacer rollback, detén la máquina",Total:"",Type:"Tipo",UUID:"UUID","User UUID":"UUID usuario","User script":"Script usuario",Users:"Usuarios",VLan:"",VM:"",Variables:"",Version:"Versión",Versioning:"Versión","Virtual Machines":"Máquinas","Web Panel":"Panel web","Welcome {{user.name}}!":"Bienvenido {{user.name}}!","You are part of":"Eres parte de","You roles are":"Tus grupos son","Your cloud is fine!":"Tu nube se ve bien!","Your cloud needs some attention!":"Tu nube necesita ayuda!",Yubikeys:"","ZFS free":"ZFS libre","ZFS size":"Tamaño ZFS","ZFS used":"ZFS usado",Zoom:"","Zpool profile":"Perfil Zpool",add:"agregar",called:"llamada","delete":"borrar",local:"",machine:"Máquina",of:"de"})}]),angular.module("fifoApp").factory("wiggle",["$resource","$http","$cacheFactory","$q","$cookies",function(a,b,c,d,e){function f(a){var b="/api/0.1.0/";h=a.split(":").length>2?a.replace(/:([^:]*)$/,"\\:$1")+b:a+b,g(),Config.endpoint=h;var c=a||window.location.protocol+"//"+window.location.host;Config.wsUrl=Config.wsUrl||c.replace(/^http/,"ws"),Config.apiPath=b}function g(){function b(a){return a=a||{},angular.extend({"x-snarl-token":d},a)}var d=e["x-snarl-token"];q.sessions=a(h+"sessions/:id",{id:"@id"},{get:{method:"GET",interceptor:{response:p},headers:b()},login:{method:"POST",interceptor:{response:p}}}),q.users=a(h+"users"+o,{id:"@id",controller:"@controller",controller_id:"@controller_id",controller_id1:"@controller_id1",controller_id2:"@controller_id2",controller_id3:"@controller_id3"},{put:{method:"PUT",headers:b()},grant:{method:"PUT",headers:b()},revoke:{method:"DELETE",headers:b()},create:{method:"POST",headers:b()},"delete":{method:"DELETE",headers:b()},query:{method:"GET",isArray:!0,headers:b({"x-full-list":!0})},queryFull:{method:"GET",isArray:!0,headers:b({"x-full-list":!0}),interceptor:{response:function(a){return a.resource.forEach(function(a){a._roles=a.roles.map(function(a){var b=q.roles.get({id:a});return b.$promise.catch(function(){b.name="?",b.uuid=a,b.deleted=!0}),b}),a._orgs=a.orgs.map(function(a){var b=q.orgs.get({id:a});return b.$promise.catch(function(){b.name="?",b.uuid=a,b.deleted=!0}),b})}),a.resource}}}}),q.roles=a(h+"roles"+o,{id:"@id",controller:"@controller",controller_id:"@controller_id",controller_id1:"@controller_id1",controller_id2:"@controller_id2",controller_id3:"@controller_id3"},{put:{method:"PUT",headers:b()},get:{method:"GET",cache:!0,headers:b()},grant:{method:"PUT",headers:b()},revoke:{method:"DELETE",headers:b()},create:{method:"POST",headers:b()},"delete":{method:"DELETE",headers:b()},query:{method:"GET",isArray:!0,headers:b({"x-full-list":!0})}}),q.orgs=a(h+"orgs"+o,{id:"@id",controller:"@controller",controller_id:"@controller_id",controller_id1:"@controller_id1",controller_id2:"@controller_id2",controller_id3:"@controller_id3"},{put:{method:"PUT",headers:b()},get:{method:"GET",cache:!0,headers:b()},grant:{method:"PUT",headers:b()},revoke:{method:"DELETE",headers:b()},create:{method:"POST",headers:b()},"delete":{method:"DELETE",headers:b()},query:{method:"GET",isArray:!0,headers:b({"x-full-list":!0})}}),q.cloud=a(h+"cloud/:controller",{controller:"@controller"},{get:{method:"GET",headers:b()}}),q.hypervisors=a(h+"hypervisors/:id/:controller/:controller_id",{id:"@id",controller:"@controller",controller_id:"@controller_id"},{put:{method:"PUT",headers:b()},"delete":{method:"DELETE",headers:b()},get:{method:"GET",cache:c.get("hypervisors"),headers:b(),interceptor:{response:function(a){var b=c.get("hypervisors");return b.info().size>0&&setTimeout(function(){b.info().size<1||b.removeAll()},4e3),a.resource}}},query:{method:"GET",isArray:!0,headers:b({"x-full-list":!0})},queryFull:{method:"GET",isArray:!0,headers:b({"x-full-list":!0}),interceptor:n}}),q.vms=a(h+"vms/:id/:controller/:controller_id",{id:"@id",controller:"@controller",controller_id:"@controller_id"},{put:{method:"PUT",headers:b()},get:{method:"GET",headers:b(),interceptor:{response:function(a){return l(a.resource)}}},query:{method:"GET",isArray:!0,headers:b({"x-full-list":!0})},queryFull:{method:"GET",isArray:!0,headers:b({"x-full-list":"true","x-full-list-fields":"uuid,datset,package,config,hypervisor,owner,metadata,state"}),interceptor:{response:function(a){return a.resource.forEach(l),a.resource.hash=m(a.resource),a.resource}}}}),q.ipranges=a(h+"ipranges/:id",{id:"@id"},{create:{method:"POST",headers:b()},get:{method:"GET",cache:!0,headers:b()},"delete":{method:"DELETE",headers:b()},query:{method:"GET",isArray:!0,headers:b({"x-full-list":!0})}}),q.networks=a(h+"networks"+o,{id:"@id",controller:"@controller",controller_id:"@controller_id",controller_id1:"@controller_id1",controller_id2:"@controller_id2"},{put:{method:"PUT",headers:b(),interceptor:{response:function(a){c.get("networks").remove(h+"networks/"+a.resource.id)}}},create:{method:"POST",headers:b()},get:{method:"GET",cache:c.get("networks"),headers:b()},getFull:{method:"GET",cache:c.get("networks"),headers:b(),interceptor:{response:function(a){return a.resource._ipranges=a.resource.ipranges&&a.resource.ipranges.map(function(a){return q.ipranges.get({id:a})}),a.resource}}},"delete":{method:"DELETE",headers:b(),interceptor:{response:function(){c.get("networks").removeAll()}}},query:{method:"GET",isArray:!0,headers:b({"x-full-list":!0})},queryFull:{method:"GET",isArray:!0,headers:b({"x-full-list":!0}),interceptor:{response:function(a){return a.resource.hash=m(a.resource),a.resource.forEach(function(a){a._ipranges=a.ipranges&&a.ipranges.map(function(a){return q.ipranges.get({id:a})})}),a.resource}}}}),q.datasets=a(h+"datasets/:id",{id:"@id"},{"import":{method:"POST",headers:b()},get:{method:"GET",cache:c.get("datasets"),headers:b()},put:{method:"PUT",headers:b(),interceptor:{response:function(a){c.get("datasets").remove(h+"datasets/"+a.resource.id)}}},query:{method:"GET",isArray:!0,headers:b({"x-full-list":!0})}}),q.packages=a(h+"packages/:id",{id:"@id"},{create:{method:"POST",headers:b()},get:{method:"GET",cache:!0,headers:b()},"delete":{method:"DELETE",headers:b()},query:{method:"GET",isArray:!0,headers:b({"x-full-list":!0})}}),q.dtrace=a(h+"dtrace/:id",{id:"@id"},{create:{method:"POST",headers:b()},get:{method:"GET",headers:b()},"delete":{method:"DELETE",headers:b()},query:{method:"GET",isArray:!0,headers:b({"x-full-list":!0})}}),j(),k()}var h,i=function(a){if(null==a)return!0;if(a.length&&a.length>0)return!1;if(0===a.length)return!0;for(var b in a)if(hasOwnProperty.call(a,b))return!1;return!0},j=function(){["hypervisors","vms"].forEach(function(a){q[a].list=function(c,d){return b.get(h+a).success(c).error(function(a){d&&d(a)})}})},k=function(){["hypervisors","orgs","vms","networks","ipranges","datasets","packages","users","sessions","roles","dtrace"].forEach(function(a){q[a].put&&(q[a].prototype.mdata_set=function(b,c){var d=this.uuid,e=this;if(!i(b))return q[a].put({id:d,controller:"metadata",controller_id:"jingles"},b,function(){Object.keys(b).forEach(function(a){e.metadata||(e.metadata={}),e.metadata.jingles||(e.metadata.jingles={}),e.metadata.jingles[a]=b[a],c&&c(b)})})}),q[a].prototype.mdata=function(a){var b=this.metadata;return b&&b.jingles&&b.jingles[a]}})},l=function(a){return a.config?(a.config.dataset&&(a.config._dataset=q.datasets.get({id:a.config.dataset})),a.package&&(a._package=q.packages.get({id:a.package})),a.owner&&(a._owner=q.orgs.get({id:a.owner})),a.hypervisor&&"pooled"!=a.hypervisor&&(a._hypervisor=q.hypervisors.get({id:a.hypervisor})),a):void 0},m=function(a){var b={};return a.forEach(function(a){b[a.uuid||a.dataset]=a}),b},n={response:function(a){return a.resource.hash=m(a.resource),a.resource}};c("datasets"),c("networks"),c("hypervisors");var o="/:id/:controller/:controller_id/:controller_id1/:controller_id2/:controller_id3",p=function(a){var b=a.resource;if(b._roles={},!b.roles)return b;var c=b.roles.map(function(a){return q.roles.get({id:a}).$promise});return d.all(c).then(function(a){return a.forEach(function(a){b._roles[a.uuid]=a}),b}).catch(function(){return b})},q={};return q.setEndpoint=f,q.setUp=function(){f(Config.backends&&Config.backends[0]&&Config.backends[0].endpoint?Config.backends[0].endpoint:"")},q.setUp(),q}]),angular.module("fifoApp").controller("MainCtrl",["$scope","wiggle","auth",function(a,b,c){a.msgTrClass=function(a){return"critical"==a?"danger":a},a.adjustMessage=Config.adjustMessage,c.userPromise().then(function(){a.user=c.currentUser(),a.keys=Object.keys(a.user.keys).length,a.user.org&&(a.activeOrg=b.orgs.get({id:a.user.org}))}),a.$on("memorychange",a.show)}]),angular.module("fifoApp").controller("HeaderCtrl",["$scope","breadcrumbs","$location","$route","$rootScope","$http","gettextCatalog","auth","howl","wiggle","$cookies",function(a,b,c,d,e,f,g,h,i,j,k){a.breadcrumbs=b,a.isActive=function(a){return null!==c.path().match(a)},a.auth=h;var l=[["cloud","orgs","list"],["cloud","users","list"],["cloud","packages","list"],["cloud","networks","list"],["cloud","dtraces","list"]];h.userPromise().then(function(){var b=!1;l.forEach(function(a){h.canAccess(a)&&(b=!0)}),a.showConfig=b}),e.$on("$routeChangeSuccess",function(b,c){a.helpUrl=c.helpUrl||"",document.title=c.name?g.getString(c.name)+" - FiFo":"FiFo Cloud"}),e.$watch(function(){return f.pendingRequests.length},function(){a.loading=f.pendingRequests.length}),a.lang=g.currentLanguage,a.setLang=function(b){a.lang=g.currentLanguage=b};var m=Object.keys(g.strings);m.indexOf("gb")<1&&m.push("gb"),a.languages=m.sort(),a.changeBackend=function(a){j.setEndpoint(a.endpoint),d.reload(),k.backend=JSON.stringify(a)},a.backends=Config.backends||[{name:"This",endpoint:""}],a.selected_backend=a.backends[0];try{if(k.backend){var n=JSON.parse(k.backend);a.changeBackend(n),a.backends.forEach(function(b){return b.endpoint==n.endpoint?a.selected_backend=b:void 0})}}catch(o){console.error("Invalid backend cookie:",o),delete k.backend}}]),angular.module("fifoApp").controller("MachinesCtrl",["$scope","$http","$filter","wiggle","status","vmService","$q","auth","ngTableParams",function(a,b,c,d,e,f,g,h,i){a.auth=h,a.infinitScroll=function(){a.tableParams.count(a.tableParams.count()+20)},a.start=function(a){f.executeAction("start",a.uuid,a.config&&a.config.alias)},a.connect=function(a){window.open("kvm"==a.config.type?"vnc.html?uuid="+a.uuid:"console.html?uuid="+a.uuid)},a.hasMore=function(){return a.tableParams.count()<a.vms.length};var j=function(){var b=a.tableParams,d=a.searchQuery&&a.searchQuery.length>=(Config.minCharsSearch||3)?c("filter")(a.vms,a.searchQuery):a.vms;d=b.sorting()?c("orderBy")(d,b.orderBy()):d,a.vmsFiltered=d.slice((b.page()-1)*b.count(),b.page()*b.count())},k=function(){a.$on("state",function(b,c){var d=a.vms.hash[c.channel];if(d){var g=function(a){e.error("The creation of the VM "+d.config.alias+"("+d.uuid+") failed. <br/>"+a)};d.state=c.message.data,f.updateCustomFields(d),"failed"==d.state&&g(d.state_description),n(),a.$apply()}}),a.$on("update",function(b,c){m.then(function(){var b=a.vms.hash[c.channel],e=c.message.data,g=e.hypervisor;g&&(b.hypervisor=g,b._hypervisor=d.hypervisors.get({id:g}));var h=e.owner;h&&(b.owner=h,b._owner=d.orgs.get({id:h}));var i=e.package;if(i&&(b.package=i,b._package=d.packages.get({id:i})),e.config){b.config=e.config,f.updateCustomFields(b);var j=e.config.dataset;j&&(b.config.dataset=j,b.config._dataset=d.datasets.get({id:j}))}})}),a.$on("delete",function(b,c){m.then(function(){for(var b=0;b<a.vms.length;b++)if(a.vms[b].uuid==c.channel){a.vms.splice(b,1);break}j()})}),a.$watch("searchQuery",function(a){j(),"undefined"!=typeof a&&h.currentUser().mdata_set({vm_searchQuery:a})})},l=function(){var b=g.defer();return a.tableParams=new i({page:1,count:25,total:0,sorting:{"config.alias":"desc"},counts:[]},{getData:function(b){j(),b.resolve(a.vmsFiltered)}}),a.vmsFiltered=[],a.vms=d.vms.queryFull(),a.vms.$promise.then(function(a){a.forEach(f.updateCustomFields),b.resolve(),k()}),b.promise},m=l(),n=function(){var b={};a.vms.forEach(function(a){b[a.state]||(b[a.state]={count:0,_state_label:a._state_label}),b[a.state].count++}),a.legend=[];for(var c in b)a.legend.push({state:c,count:b[c].count,_state_label:b[c]._state_label})};m.then(n),h.userPromise().then(function(){a.searchQuery=h.currentUser().mdata("vm_searchQuery")})}]),angular.module("services.breadcrumbs",[]),angular.module("services.breadcrumbs").factory("breadcrumbs",["$rootScope","$location",function(a,b){function c(a){var b=a.split("-").map(function(a){return a.charAt(0).toUpperCase()+a.slice(1)});return b.join(" ")}var d=[],e={};return a.$on("$routeChangeSuccess",function(a,e){var f,g=b.path().split("/"),h=[],i=function(a){return"/"+g.slice(0,a+1).join("/")};for(g.shift(),f=0;f<g.length;f++){if("/"==i(f))return d=[];h.push(f==g.length-1?{name:e.name||c(g[f]),path:i(f)}:{name:c(g[f]),path:i(f)})}d=h}),e.getAll=function(){return d},e.getFirst=function(){return d[0]||{}},e.setLast=function(a){d[d.length-1].name=c(a)},e}]),angular.module("fifoApp").controller("DatasetsCtrl",["$scope","wiggle","datasetsat","status","$upload",function(a,b,c,d,e){a.datasets={},a.datasetsat={},a.endpoint=Config.datasets;var f=function(){function a(a){var b=(Math.random().toString(16)+"000000000").substr(2,8);return a?"-"+b.substr(0,4)+"-"+b.substr(4,4):b}return a()+a(!0)+a(!0)+a()};a.import=function(e){var f=a.url;e&&(f=c.endpoint+"/datasets/"+e),b.datasets.import({},{url:f},function(b){howl.join(e),a.datasets[e]=b,d.info("Importing "+b.name+" "+b.version),a.datasetsat[e]&&(a.datasetsat[e].imported=!0)},function(a){d.error("Could not import dataset"),console.error(a)})},a.delete=function(c){a.modal={btnClass:"btn-danger",confirm:"Delete",title:"Confirm Dataset Deletion",body:'<p><font color="red">Warning!</font> you are about to delete dataset <b>'+c.name+" v"+c.version+" ("+c.dataset+")</b> Are you 100% sure you really want to do this?</p>",ok:function(){b.datasets.delete({id:c.dataset},function(){delete a.datasets[c.dataset],d.success("Dataset deleted.");var b=a.datasetsat[c.dataset];b&&(b.imported=!1)},function(){d.error("Could not delete Dataset")})}}},a.$on("progress",function(b,c){a.$apply(function(){var b=c.message.data.imported;a.datasets[c.channel].imported=b,a.datasets[c.channel].status=1===b?"imported":"importing"})}),a.show=function(){return b.datasets.query(function(b){b.forEach(function(b){var c=b.dataset;howl.join(c),b.status||(b.status=1===b.imported?"imported":"pending"),a.datasets[c]=b})}),Config.datasets?(a.loadingRemoteDatasets=!0,void c.datasets.query(function(b){b.forEach(function(b){var c=a.datasets[b.uuid];b.imported=c&&c.imported&&c.imported>0||!1,a.datasetsat[b.uuid]=b
}),a.loadingRemoteDatasets=!1},function(b){d.error("Could not load remote datasets "+b.status),console.error(b),a.loadingRemoteDatasets=!1})):d.error("Make sure your config has an URL for the remote datasets")},a.show();var g=f();g="cec0e6ff-a1ca-33e5-8d2f-9b3bb4ebf871",a.onFileSelect=function(a){var b=a[0],c=new FileReader;c.onprogress=function(a){console.log(100*a.loaded/a.total)},c.onload=function(){console.log("ONLOAD!!");var a=Config.endpoint+"datasets/"+g+"/datassetss.tar.gz",d=e.http({url:a,headers:{"Content-Type":b.type},data:c.result});d.then(function(a){console.log("---> RES",a)},null,function(a){console.log("--> EVT:",a.loaded,a.total,parseInt(100*a.loaded/a.total))})},c.readAsArrayBuffer(b),console.log("subiendo esto...",b)}}]),angular.module("fifoApp").controller("ServersCtrl",["$scope","wiggle","status",function(a,b){a.hypervisors=b.hypervisors.queryFull(),a.$on("memorychange",function(b,c){a.hypervisors.hash[c.channel]["free-memory"]=c.message.data.free,a.hypervisors.hash[c.channel]["provisioned-memory"]=c.message.data.provisioned,a.$apply()})}]);var fifoApp=angular.module("fifoApp");fifoApp.filter("hash2array",function(){return function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&"$"!=c[0]&&(a[c]._key=c,b.push(a[c]));return b}}),fifoApp.filter("orDefault",function(){return function(a,b){return a&&""!=a?a:b}});var formatBytes=function(a){return function(b,c){if(!isNaN(parseFloat(b))&&isFinite(b)){if(1>b)return b;c=c||{};var d=c.pow1024||a||0,e=c.precision||1,f=["bytes","kB","MB","GB","TB","PB"];b*=Math.pow(1024,d);var g=Math.floor(Math.log(b)/Math.log(1024)),h=(b/Math.pow(1024,Math.floor(g))).toFixed(e);return h=h.replace(/(.\d*?)0*$/,"$1").replace(/(.*?)\.$/,"$1"),h+""+f[g]}}};fifoApp.filter("bytes",function(){return formatBytes()}),fifoApp.filter("Mbytes",function(){return formatBytes(2)}),fifoApp.filter("Gbytes",function(){return formatBytes(3)}),fifoApp.filter("humanize",function(){return function(a){var b=a.split("-").map(function(a){return a.charAt(0).toUpperCase()+a.slice(1)});return b.join(" ")}}),angular.module("fifoApp").directive("jqRun",function(){return{restrict:"A",compile:function(){return function(a,b,c){if("tooltip"==c.jqRun&&b.children().length>0){var d=b.children()[0];$(d).on("click",function(){$(b).tooltip("hide")})}var e=c;setTimeout(function(){c.jqOptions&&(e=a.$eval(c.jqOptions)),$(b)[c.jqRun](e)},500)}}}}),angular.module("fifoApp").directive("package",function(){return{restrict:"E",transclude:!0,replace:!0,scope:{pkg:"=",vmconfig:"=",title:"@title"},template:"<dl class='dl-horizontal'><dt>CPU</dt><dd ng-show='!vmconfig'>Share: {{pkg.ram}}<br/>Cap: {{pkg.cpu_cap}}</dd><dd ng-show='vmconfig.vcpus'>{{vmconfig.vcpus}}</dd><dd ng-hide='!vmconfig || vmconfig.vcpus'>{{vmconfig.cpu_shares && 'Share: ' + vmconfig.cpu_shares}}</br>{{vmconfig.cpu_cap && 'Cap: ' + vmconfig.cpu_cap}}</dd><dt>Ram</dt><dd class='memory'>{{(pkg.ram || vmconfig.ram) | Mbytes}}</dd><dt>Disk</dt><dd class='memory' ng-hide='vmconfig.disks'>{{(pkg.quota || vmconfig.quota) | Gbytes}}</dd><dd class='memory' ng-repeat='disk in vmconfig.disks'><span title='{{disk.model}} {{disk.bool && \"(booteable)\" || \"\"}}' jq-run='tooltip'>{{disk.size | Mbytes}}</span></dd><dt ng-show='(vmconfig || pkg).zfs_io_priority'>IO Prio</dt><dd class='memory' ng-show='(vmconfig || pkg).zfs_io_priority'>{{(vmconfig || pkg).zfs_io_priority}}</dd></dl>"}}),angular.module("fifoApp").directive("typeahead",["$parse",function(a){return{restrict:"E",replace:!0,scope:{source:"&",show:"="},template:"<input type='text' ng-show='show' />",link:function(b,c,d){function e(c){var e=a(d.ngModel);return e.assign(b.$parent,c),c}b.$watch(d.ngModel,e),$(c).typeahead({local:b.source()}).on("typeahead:selected",function(a,b){e(b.value)})}}}]),angular.module("fifoApp").directive("gauge",function(){return{restrict:"E",replace:!0,template:"<canvas class='gauge'></canvas>",link:function(a,b,c){var d=new Gauge(b[0]).setOptions({pointer:{length:.8},limitMax:!0,colorStop:"blue",strokeColor:"#E0E0E0",percentColors:[[0,"#45d70b"],[.9,"#dede0b"],[1,"#ff0000"]]});d.maxValue=100,d.animationSpeed=10,a.$watch(c.ngModel,function(a){d.set(1*a||0)})}}}),angular.module("fifoApp").directive("permission",["auth",function(a){return{restrict:"AE",scope:{permission:"@"},link:function(b,c,d){function e(){if(a.currentUser()&&a.currentUser().name){var b=a.canAccess(g);b?f&&c.attr("style","display: "+f):c.css("display","none")}}var f=c.css("display");c.css("display","none");var g=b.$eval(d.permission);b.$watch(function(){return a.currentUser()},e),d.$observe("permission",function(a){g=b.$eval(a),e()})}}}]),angular.module("fifoApp").factory("status",["auth",function(){return{success:function(a){alertify.success(a)},info:function(a){alertify.log(a)},error:function(a){alertify.error(a)},prompt:function(a,b,c){alertify.prompt(a,function(a,c){""!=c&&a&&b(c)},c)}}}]),angular.module("fifoApp").factory("vmService",["status","wiggle",function(a,b){var c=function(a,b,c){return Array(b-String(a).length+1).join(c||"0")+a},d={start:"Starting",stop:"Stopping",reboot:"Rebooting"};return{executeAction:function(c,e,f,g,h){var i=f||e;if("delete"==c)return b.vms.delete({id:e},function(){a.info("Deleting machine "+i),h&&h(c,e)});var j={action:c};return!g||"stop"!=c&&"reboot"!=c||(j.force=!0),b.vms.put({id:e},j,function(b,f){return f?(a.info(d[c]+" machine "+i),void(h&&h(c,e))):a.error("An error 500 has occur. :(")})},updateCustomFields:function(a){switch(a._name=a.config&&a.config.alias||a.uuid&&a.uuid.split("-")[0],a.state){case"failed":a.state_description="Could not create the VM with vmadm.",a._state_label="danger";break;case"pooled":a.state_description="Enqueued to be created on a server.",a._state_label="default";break;case"failed-get_ips":a.state_description="No IP address for the machine could be obtained.",a.state="failed",a._state_label="danger";break;case"failed-get_dataset":a.state_description="The dataset could not be retrieved.",a.state="failed",a._state_label="danger";break;case"failed-get_package":a.state_description="The package could not be retrieved.",a.state="failed",a._state_label="danger";break;case"failed-get_server":a.state_description="No suitable server to deploy the VM on could be found.",a.state="failed",a._state_label="danger";break;case"running":a.state_description="The VM is running.",a._state_label="success";break;case"stopped":a.state_description="The VM is stopped.",a._state_label="default";break;case"creating":a.state_description="The VM is currently bing provisioned on the hypervisor.",a._state_label="warning";break;case"installing_dataset":a.state_description="The dataset for the VM is currently being installed on the hypervisor.",a.state="creating",a._state_label="warning";break;case"shutting_down":a.state_description="The VM is currently shutting down.",a.state="shutting down",a._state_label="warning";break;case"booting":a.state_description="The VM is currently booting.",a._state_label="warning";break;case"deleting":a.state_description="The VM is being deleted.",a._state_label="danger";break;default:a.state_description=a.state,a._state_label="warning"}if(!a.config)return a;a.config.created_at||(a.config.created_at=new Date),a._name=a.config.alias||a.uuid.split("-")[0];var b=(a.config.networks||[]).filter(function(b){return a.config.networks.length<2||"true"==b.primary}).map(function(a){return a.ip}).filter(function(a){return a});return a._ips=b.length>0?b.join(", "):a.config.networks&&a.config.networks[0].ip,a._cpu=a.config.vcpu||a.config.cpu_shares,a._cpu_tooltip=a.config.vcpu?a.config.vcpu+" CPU":a.config.cpu_cap?"Shares: "+a.config.cpu_shares+"</br>Cap:"+a.config.cpu_cap:"Shares: "+a.config.cpu_shares,a._ips_normalized=b.length>0?b.map(function(a){return a&&a.split(".").map(function(a){return c(a,3)}).join(".")}).join(", "):a.config.networks&&a.config.networks[0].ip,a}}}]),angular.module("fifoApp").controller("MachineCtrl",["$scope","$routeParams","$location","wiggle","vmService","status","breadcrumbs","datasetsat",function(a,b,c,d,e,f,g,h){a.force=!1;var i=b.uuid,j=function(a){if(!a)return a;var b=a.split(".").map(function(a){return parseInt(a)});return b[b.length-1]=b[b.length-1]+1,b.join(".")},k=new MetricsGraph("throughput",{unit:"KB/s",size:60,series:[{scale:1024,options:{color:"#B6E7AC",label:"read"}},{scale:1024,options:{color:"#69B3E4",label:"write"}}]}),l=new MetricsGraph("ops",{unit:"OPS/s",size:60,series:[{options:{color:"#B6E7AC",label:"read"}},{options:{color:"#69B3E4",label:"write"}}]}),m=new MetricsGraph("memory",{unit:"MB",size:60,series:[{scale:1048576,options:{color:"#FFA455",label:"cap"},type:"absolute"},{options:{color:"#9E9AC8",label:"RSS"},scale:1048576,type:"absolute"}]}),n=new MetricsGraph("swap",{unit:"MB",size:60,series:[{color:"#FFA455",label:"cap",scale:1048576,type:"absolute"},{color:"#9E9AC8",label:"used",scale:1048576,type:"absolute"}]}),o=new MetricsGraph("cpu",{unit:"%",size:60,min:0,series:[{options:{color:"#FFA455",label:"usage"},type:"absolute"},{options:{color:"#9E9AC8",label:"max"},type:"absolute"}]}),p={},q={};a.$on("$destroy",function(){howl.leave(i+"-metrics")});var r=function(a,b){var c='<div class="perfbox pull-left"><div class="header"><span class="badge badge-info">'+a+'</span></div><div id="'+b+'" class="metric"></div></div>';$("#performance").append(c)};a.$on("net",function(a,b){if(!(b.channel.indexOf(i)<0)){var c=b.message.data,d=c.ifname;if(!q[d]){var e="netdata_"+d;r(d+": Throughput",e),q[d]=new MetricsGraph(""+e,{unit:"KB/s",size:60,series:[{options:{color:"#B6E7AC",label:"in KB/s"},scale:1024},{options:{color:"#69B3E4",label:"out KB/s"},scale:1024}]})}if(!p[d]){var e="netpkg_"+d;r(d+": Packets",e),p[d]=new MetricsGraph(""+e,{unit:"PKG/s",size:60,series:[{options:{color:"#B6E7AC",label:"in rate"}},{options:{color:"#69B3E4",label:"out rate"}},{options:{color:"#D73027",label:"in error/s"}},{options:{color:"#E16767",label:"out error/s"}}]})}p[d].add([c.ipackets64,c.opackets64,c.ierrors,c.oerrors]),q[d].add([c.rbytes64,c.obytes64])}}),a.$on("vfs",function(a,b){if(!(b.channel.indexOf(i)<0)){var c=b.message.data;l.add([c.reads,c.writes]),k.add([c.nread,c.nwritten])}}),a.$on("memstat",function(a,b){if(!(b.channel.indexOf(i)<0)){var c=b.message.data;m.add([c.physcap,c.rss]),n.add([c.swapcap,c.swap])}}),a.$on("cpu",function(a,b){if(!(b.channel.indexOf(i)<0)){var c=b.message.data;o.add([c.usage,c.value])}}),a.service_action=function(b,c){d.vms.put({id:a.vm.uuid,controller:"services"},{action:b,service:c},function(){f.info(b+" event sent to service "+c.split("/").pop())},function(){f.error("Could not send event "+b+" to service "+c.split("/").pop())})},a.confirm_freeze=function(){var b=a.vm;a.modal={title:"Confirm VM Removal",btnClass:"btn-danger",confirm:"Remove",body:'<p><font color="red">Warning!</font> you are about to remove the VM <b id="delete-uuid">'+b.uuid+" "+(b.config&&b.config.alias?"("+b.config.alias+")":"")+"</b> from the hypervisor but leave backups in storage. Are you 100% sure you really want to do this?</p><p>This feature is experimental!</p>",ok:function(){d.vms.delete({id:b.uuid,controller:"hypervisor"},function(){s(),f.success("VM moved to storage.")},function(a){f.error("Error removing nic from storage."),console.log(a)})}}},a.prevent_freeze=function(){var b=a.vm;if(!b)return!0;var c=!1;for(var d in b.backups||{})void 0==b.backups[d].parent&&(c=!0);return"stopped"!=b.state||!c||b.mdata("locked")};var s=function(b){d.vms.get({id:i},function(c){a.vm=e.updateCustomFields(c),g.setLast(a.vm._name);var d="custom";if(a.vm["package"]&&(d=a.vm["package"]+""),a.vm.config){a.packages[d]||(a.packages[d]={id:d,name:a.vm._package&&a.vm._package.name,ram:a.vm.config.ram,cpu_shares:a.vm.config.cpu_shares,vcpus:a.vm.config.vcpus,cpu_cap:a.vm.config.cpu_cap,quota:a.vm.config.quota}),a.new_pkg=d,a.description=a.vm.mdata("description"),a.configHash=angular.copy(a.vm.config),a.color=a.vm.mdata("color");var f=a.vm.mdata("notes")&&a.vm.mdata("notes").sort(function(a,b){return a.created_at>=b.created_at});a.notes=f?f.reverse():[],a.snapshots=a.vm.snapshots||{},a.backups=a.vm.backups||{},a.routes=[];var h=a.vm.config.routes;if(h)for(var i in h)routes.push({destination:i,gateway:h[i]});b&&b(a.vm),a.img_name=a.vm.config.alias,a.img_version=j(a.vm.config._dataset&&a.vm.config._dataset.version),a.img_os=a.vm.config._dataset&&a.vm.config._dataset.os,a.img_desc=a.vm.config._dataset&&a.vm.config._dataset.description,a.show_disabled_services=a.vm.mdata("show_disabled_services")||!1,a.$watch("show_disabled_services",function(){a.vm.mdata_set({show_disabled_services:a.show_disabled_services})})}},function(){a.something_wrong=!0})};a.update=function(){d.vms.put({id:a.vm.uuid},{"package":a.new_pkg},function(){f.info("Resizing "+a.vm._name+"..."),s(function(){a.vm.config.ram="",a.vm.config.vcpus="",a.vm.config.cpu_shares="",a.vm.config.cpu_cap="",a.vm.config.quota=""}),"kvm"==a.vm.config.type&&f.error("Reboot on this machine is needed for resize to take effect")})},a.$on("state",function(b,c){c.channel==i&&(a.vm.state=c.message.data,e.updateCustomFields(a.vm),"stopped"===a.vm.state&&(a.force=!1),a.$apply())}),a.$on("delete",function(b,d){d.channel==i&&(c.path("/machines"),a.$apply())}),a.$on("update",function(b,c){if(c.channel==i){var d=c.message.data.config;Object.keys(d).forEach(function(b){a.vm.config[b]=d[b]}),e.updateCustomFields(a.vm),a.$apply()}}),a.$on("log",function(b,c){c.channel==i&&(a.vm.log.push(c.message.data),a.$apply())}),a.$on("backup",function(b,c){if(c.channel==i){var d=c.message.data;switch(d.action){case"update":var e=a.backups[d.uuid];d.data.size&&(e.size=d.data.size),d.data.state&&(e.state=d.data.state),"undefined"!=typeof d.data.local&&(e.local=d.data.local);break;case"deleted":delete a.backups[d.uuid],f.success("Backup deleted");break;case"restored":s(),f.success("Rolled back successfully");break;default:console.log("Unknown backup event:",d)}a.$apply()}}),a.$on("snapshot",function(b,c){if(c.channel==i){var d=c.message.data;switch(d.action){case"deleted":a.snapshots[d.uuid]&&(a.snapshots[d.uuid].local?a.snapshots[d.uuid].local=!1:(delete a.snapshots[d.uuid],f.success("Snapshot deleted")));break;case"rollback":s(),f.success("Rolled back successfully");break;default:var e=a.snapshots[d.uuid];e.state=d.action,e.message=d.message}a.$apply()}}),a.$watch("color",function(b){"undefined"!=typeof b&&a.vm&&b!=a.vm.mdata("color")&&(a.vm.mdata_set({color:b}),f.info("Color changed"))}),a.save_vm_info=function(b){var c={alias:b.alias,hostname:b.hostname,resolvers:b.resolvers&&b.resolvers.toString().split(",")};a.description!=a.vm.mdata("description")&&(a.vm.mdata_set({description:a.description}),f.info("Description changed"));var e=!0;return c.resolvers&&c.resolvers.length>0&&c.resolvers.forEach(function(a){e=e&&a.match(/^\d{1,3}.\d{1,3}.\d{1,3}.\d{1,3}$/)}),e?(a.new_owner&&a.new_owner.uuid&&d.vms.put({id:a.vm.uuid,controller:"owner"},{org:a.new_owner&&a.new_owner.uuid},function(){f.info("Owner changed"),a.vm._owner=a.new_owner},function(a){f.error("Could not change owner"),console.error(a)}),void d.vms.put({id:a.vm.uuid},{config:c},function(){f.info("Config changed"),a.vm.config.alias=b.alias})):f.error("Resolvers are not valid. Cannot save config.")},a.primary_nic=function(a,b){d.vms.put({id:a.uuid,controller:"nics",controller_id:b},{primary:!0},function(){f.success("Primary NIC changed."),s()},function(a){f.error("Error when changing the primary nic. See the history"),console.log(a)})},a.remove_nic=function(a,b){d.vms.delete({id:a.uuid,controller:"nics",controller_id:b},function(){s(),f.success("NIC "+b+" deleted")},function(a){f.error("Error deleting the nic. See your console"),console.log(a)})},a.delete_route=function(b){d.vms.put({id:a.vm.uuid},{config:{remove_routes:b.destination}},function(){f.success("Route deleted"),a.routes.splice(a.routes.indexOf(b),1)},function(a){f.error("Could not delete route"),console.error(a)})},a.save_routes=function(b){var c={};b.forEach(function(a){c[a.destination]=a.gateway}),d.vms.put({id:a.vm.uuid},{config:{set_routes:c}},function(a){console.log("ok!",a),f.success("Routes changed")},function(a){f.error("Could not save routes"),console.error(a)})},a.add_nic=function(a,b){d.vms.save({id:a.uuid,controller:"nics"},{network:b},function(){f.success("NIC added."),s(),$('#VMTab a[href="#details"]').tab("show")},function(a){f.error("Error creating NIC. See your console"),console.log(a)})},a.action=function(b,d){"stop"==b&&setTimeout(function(){"running"==a.vm.state&&(a.force=!0,a.$apply())},1e3*Config.timeForceButton),e.executeAction(b,d.uuid,d.config&&d.config.alias,a.force,function(){"delete"==b&&c.path("/machines")})},a.confirm_delete=function(b){a.modal={title:"Confirm VM Deletion",btnClass:"btn-danger",confirm:"Delete",body:'<p><font color="red">Warning!</font> you are about to delete VM <b id="delete-uuid">'+b.uuid+" "+(b.config&&b.config.alias?"("+b.config.alias+")":"")+"</b> Are you 100% sure you really want to do this?</p><p>Clicking on Delete here will mean this VM is gone forever!</p>",ok:function(){a.action("delete",b)}}},a.lock=function(){a.vm.mdata_set({locked:!a.vm.mdata("locked")})},a.console=function(a){window.open("kvm"==a.config.type?"vnc.html?uuid="+a.uuid:"console.html?uuid="+a.uuid)},a.notes=[],a.note=function(b,c){switch(b){case"create":f.prompt("Enter your note:",function(b){a.notes.splice(0,0,{text:b,created_at:new Date}),a.vm.mdata_set({notes:a.notes},function(){f.success("Note created")},function(){f.error("Could not save note"),a.notes.splice(1)})});break;case"delete":a.notes.splice(c,1),a.vm.mdata_set({notes:a.notes},function(){f.success("Note deleted")})}},a.backupAction=function(b,c){switch(b){case"create":f.prompt("Write a comment for the new backup:",function(b){var e={comment:b};c&&c.parent&&(e.parent=c.parent,e["delete"]=!0),d.vms.save({id:i,controller:"backups"},e,function(b){b.type="backup",a.backups[b.uuid]=b},function(a){f.error("Could not create. See your console"),console.error(a)})});break;case"delete":a.modal={confirm:"Delete",title:"Confirm Backup Deletion",body:"<p>Are you sure you want to delete backup <strong>"+c.comment+"</strong> dated "+new Date(c.timestamp/1e3)+"</p>",ok:function(){d.vms.delete({id:i,controller:"backups",controller_id:c._key},function(){a.backups[c._key].state="deleting"},function(a){f.error("Could not delete. See your console"),console.error(a)})}};break;case"rollback":var e=a.vm;if("stopped"==e.state)a.modal={confirm:"Rollback",btnClass:"btn-danger",title:"Confirm Rollback",body:'<p><font color="red">Warning!</font> You are about to rollback to backup <strong>'+c.comment+"</strong> dated "+new Date(c.timestamp/1e3)+"?</p></b>Are you 100% sure you really want to do this?</p>",ok:function(){f.info("Will rollback to backup "+c.comment),d.vms.put({id:i,controller:"backups",controller_id:c._key},{action:"rollback"},function(){a.backups[c._key].state="rolling..."},function(a){f.error("Error when rolling back. See the history"),console.log(a)})}};else if("stored"!=e.state&&"limbo"!=e.state||e.hypervisor||!a.restore_target)console.log("Restore impossible in state",e.state);else{var g=a.restore_target.uuid;a.modal={confirm:"Restore",btnClass:"btn-danger",title:"Confirm Restore",body:'<p><font color="red">Warning!</font> You are about to restore this vm from the backup <strong>'+c.comment+"</strong> dated "+new Date(c.timestamp/1e3)+"?</p></b>Are you 100% sure you really want to do this?</p>",ok:function(){f.info("Will restore from backup "+c.comment),d.vms.put({id:i,controller:"backups",controller_id:c._key},{action:"rollback",hypervisor:g},function(){a.backups[c._key].state="rolling..."},function(a){f.error("Error when rolling back. See the history"),console.log(a)})}}}}},a.snapshotAction=function(b,c){switch(b){case"create":f.prompt("Write a comment for the new snapshot:",function(b){d.vms.save({id:i,controller:"snapshots"},{comment:b},function(b){b.type="snapshot",a.snapshots[b.uuid]=b},function(a){f.error("Could not save. See your console"),console.error(a)})});break;case"delete":a.modal={confirm:"Delete",title:"Confirm Snapshot Deletion",body:"<p>Are you sure you want to delete snapshot <strong>"+c.comment+"</strong> dated "+new Date(c.timestamp/1e3)+"</p>",ok:function(){d.vms.delete({id:i,controller:"snapshots",controller_id:c._key},function(){a.snapshots[c._key].state="deleting"},function(a){f.error("Could not delete. See your console"),console.error(a)})}};break;case"rollback":a.modal={confirm:"Rollback",btnClass:"btn-danger",title:"Confirm Rollback",body:'<p><font color="red">Warning!</font> You are about to rollback to snapshot <strong>'+c.comment+"</strong> dated "+new Date(c.timestamp/1e3)+"?</p><p>Please note: Any snapshots that have been taken after this rollback date will be deleted if you proceed.</p></b>Are you 100% sure you really want to do this?</p>",ok:function(){f.info("Will rollback to snapshot "+c.comment),d.vms.put({id:i,controller:"snapshots",controller_id:c._key},{action:"rollback"},function(){a.snapshots[c._key].state="rolling..."},function(a){f.error("Error when rolling back. See the history"),console.log(a)})}}}},a.import_dataset=function(){var b=h.endpoint+"/datasets/"+a.vm.config.dataset;d.datasets.import({},{url:b},function(a){howl.join(i),f.info("Importing "+a.name+" "+a.version),s()},function(a){f.error("Could not import dataset "+a.status),console.error(a)})},a.mk_image=function(b,c){var e={name:a.img_name,version:a.img_version,os:a.img_os,description:a.img_desc},g={config:e,snapshot:c,vm:b};d.datasets.import({},g,function(a){howl.join(i),f.info("Creating "+a.name+" "+a.version),s()})};var t=function(){a.hypervisors={},d.hypervisors.query(function(b){b.forEach(function(b){a.hypervisors[b.uuid]=b})}),a.packages={},d.packages.query(function(b){b.forEach(function(b){var c=b.uuid;a.packages[c]=b,a.packages[c].id=c,a.packages[c].vcpus=b.cpu_cap/100,a.packages[c].cpu_shares=b.ram})}),a.networks={},d.networks.query(function(b){b.forEach(function(b){var c=b.uuid;a.networks[c]=b,a.networks[c].id=c})}),a.orgs=d.orgs.query(),d.cloud.get(function(b){a.has_s3="s3"==b.metrics.storage}),howl.join(i+"-metrics"),s()};t()}]),angular.module("fifoApp").factory("howl",["$rootScope",function(a){return howl._wsMessage=function(b){var c=howl.decode(b.data),d=c.message&&c.message.event||"main";a.$broadcast(d,c),"dev"!=Config.mode||c.pong||console.debug("[howl] receive:",c,d)},setInterval(function(){a.howlConnected!==howl._connected&&(a.howlConnected=howl._connected,a.$digest())},1e3),{connect:howl.connect,join:howl.join,send:howl.send,disconnect:howl.disconnect,connected:function(){return howl._connected}}}]);var howl={_connected:!1,_token:!1,_join_channels_on_connect:[],decode:function(a){var b=msgpack.unpack(new Uint8Array(a));return b},encode:function(a){return new Uint8Array(msgpack.pack(a)).buffer},_wsOpen:function(){var a={token:howl._token};"dev"!=Config.mode||a.ping||console.debug("[howl] auth:   ",a),howl.ws.send(howl.encode(a)),"dev"==Config.mode&&console.log("[howl] connection open"),howl._connected=!0,howl.join(howl._join_channels_on_connect),setInterval(function(){1==howl._connected&&howl._token&&howl.send({ping:1})},1e3)},_wsError:function(a){howl._connected=!1,console.log("WS ERROR:",a),console.log("[howl] connection error, reconnecting in 5[s]..."),setTimeout(howl.connect,5e3)},_wsClose:function(){howl._connected=!1,howl._token&&(console.log("[howl] connection closed, reconnecting in 5[s]..."),setTimeout(howl.connect,5e3))},disconnect:function(){howl.ws&&(howl.ws.close(),howl.ws=null),howl._connected=!1,howl._token=null},connect:function(a){howl.ws&&howl.disconnect(),a&&(howl._token=a),howl.ws=new WebSocket(Config.wsUrl+"/howl","msgpack"),howl.ws.binaryType="arraybuffer",howl.ws.onopen=howl._wsOpen,howl.ws.onclose=howl._wsClose,howl.ws.onmessage=howl._wsMessage,howl.ws.onerror=howl._wsError},send:function(a){"dev"!=Config.mode||a.ping||console.debug("[howl] send:   ",a),howl._connected&&howl.ws&&howl.ws.send(howl.encode(a))},join:function(a){return"function"==typeof a.forEach?a.forEach(howl.join):howl._connected?void howl.send({join:a}):howl._join_channels_on_connect.push(a)},leave:function(a){return"function"==typeof a.forEach?a.forEach(howl.leave):void howl.send({leave:a})}};angular.module("fifoApp").factory("datasetsat",["$resource","$http",function(a,b){var c=Config.datasets;0!=c.indexOf("http")&&(c="https://"+c);var d={endpoint:c,datasets:a(c+"/datasets/:id",{id:"@id"})};return d.datasets.get=function(a,d,e){return res=b.get(c+"/datasets/"+a.id,{cache:!0}).success(d).error(function(a){e&&e(a)})},d}]),angular.module("fifoApp").directive("simplecolorpicker",function(){return{link:function(a,b,c){var d=c.ngModel;if(d){var e=$(b);return a.$watch(d,function(a,b){a&&a!=b&&(e.val(a),$(".simplecolorpicker.icon").css("background-color",a))}),e.simplecolorpicker({picker:!0}).change(function(){var b="#ffffff"==e.val()?!1:e.val();a.$apply(function(){a[d]=b})})}}}}),angular.module("fifoApp").controller("DatasetCtrl",["$scope","$routeParams","wiggle","status","breadcrumbs",function(a,b,c,d,e){var f=b.uuid;c.datasets.get({id:f},function(b){a.dataset=b,a.networks=b.networks,e.setLast(b.name+" "+b.version)}),a.save=function(a){c.datasets.put({id:f},{networks:a},function(){d.success("Dataset changed")},function(){d.error("Could not change dataset")})}}]),angular.module("fifoApp").controller("ServerCtrl",["$scope","$routeParams","$location","utils","wiggle","vmService","status","breadcrumbs",function(a,b,c,d,e,f,g,h){var i=b.uuid;a.characteristics=[];for(var j=30,k=[],l=[],m=0;j>=m;m++)k.push(0),l.push(0);var n=new MetricsGraph("cpuusage",{unit:"%",size:60,type:"percentage",min:0,max:100,series:[{options:{color:"#FFA455",label:"system"}},{options:{color:"#69B3E4",label:"user"}},{options:{color:"#B6E7AC",label:"idle"}}]});howl.join(i+"-metrics"),a.$on("$destroy",function(){howl.leave(i+"-metrics")}),a.$on("mpstat",function(a,b){var c=(b.message.data,0),d=0,e=0,f=0;b.message.data.forEach(function(a){c+=a.user,d+=a.kernel,e+=a.idle,f+=1}),n.add([d/f,c/f,e/f])}),a.add=function(){g.prompt("Enter the key of the new characteristic:",function(b){a.characteristics.push({name:b,value:""}),a.$apply()})},a.confirm_delete=function(b){a.modal={title:"Confirm Hypervisor Deletion",btnClass:"btn-danger",confirm:"Delete",body:'<p><font color="red">Warning!</font> you are about to delete the server <b id="delete-uuid">'+b.uuid+" ("+b.alias+")</b> Are you 100% sure you really want to do this?</p><p>Clicking on Delete here will mean this server is gone and all the VM's on it are marked as migratable as long as they have a full backup! It is possible for the server to re-register at a later stage.</p>",ok:function(){e.hypervisors.delete({id:b.uuid},function(){c.path("/servers")})}}},a.del=function(b,c){e.hypervisors.delete({id:i,controller:"characteristics",controller_id:b},function(){a.characteristics.splice(c,1)})},a.save=function(){a.characteristics.forEach(function(a){var b={};b[a.name]=a.value,e.hypervisors.put({id:i,controller:"characteristics"},b)})},a.$watch("characteristics",function(a,b){b.length<1||o(a,b).forEach(function(a){var b={};b[a.name]=d.deserialize(a.value),e.hypervisors.put({id:i,controller:"characteristics"},b)})},!0);var o=function(a,b){var c=0;return a.filter(function(){var d=a[c],e=b[c];return c++,e?d.value!=e.value:!0})};a.saveAlias=function(b){e.hypervisors.put({id:a.hyper.uuid,controller:"config"},{alias:b},function(){g.info("Server name changed."),a.hyper.alias=b},function(){g.error("Could not change server name")})},a.notes=[],a.note=function(b,c){switch(b){case"create":g.prompt("Enter your note:",function(b){a.notes.splice(0,0,{text:b,created_at:new Date}),a.hyper.mdata_set({notes:a.notes},function(){g.success("Note created")},function(){g.error("Could not save note"),a.notes.splice(1)})});break;case"delete":a.notes.splice(c,1),a.hyper.mdata_set({notes:a.notes},function(){g.success("Note deleted")})}},a.service_action=function(b,c){e.hypervisors.put({id:a.hyper.uuid,controller:"services"},{action:b,service:c},function(){g.info(b+" event sent to service "+c.split("/").pop())},function(){g.error("Could not send event "+b+" to service "+c.split("/").pop())})};var p=function(){e.hypervisors.get({id:i},function(b){a.hyper=b,h.setLast(b.alias),a.new_alias=b.alias,b.characteristics&&Object.keys(b.characteristics).forEach(function(c){a.characteristics.push({name:c,value:b.characteristics[c]})});var c=a.hyper.mdata("notes")&&a.hyper.mdata("notes").sort(function(a,b){return a.created_at>=b.created_at});a.notes=c?c.reverse():[],a.show_disabled_services=a.hyper.mdata("show_disabled_services")||!1,a.$watch("show_disabled_services",function(){a.hyper.mdata_set({show_disabled_services:a.show_disabled_services})})})};p()}]),angular.module("fifoApp").factory("utils",function(){return{deserialize:function(a){var b=a;return a.indexOf(",")>-1&&(b=a.split(",")),a-0==a&&a.length>0&&(b=parseFloat(a,10)),b}}}),angular.module("fifoApp").controller("PackageCtrl",["$scope","$routeParams","wiggle","breadcrumbs",function(a,b,c,d){var e=b.uuid;c.packages.get({id:e},function(b){a.package=b,d.setLast(b.name)})}]),angular.module("fifoApp").controller("NetworkCtrl",["$scope","$routeParams","$location","wiggle","vmService","status","breadcrumbs",function(a,b,c,d,e,f,g){var h=b.uuid;a.delete=function(){var b=a.network.name,e=a.network.uuid;a.modal={btnClass:"btn-danger",confirm:"Delete",title:"Confirm VM Deletion",body:'<p><font color="red">Warning!</font> you are about to delete the Network <b id="delete-uuid">'+b+" ("+e+") </b> Are you 100% sure you really want to do this?</p><p>Clicking on Delete here will mean this Network is gone forever!</p>",ok:function(){d.networks.delete({id:e},function(){f.success(b+" deleted"),c.path("/configuration/networks")},function(a){console.error("Delete Network error:",a),f.error("There was an error deleting your network. See the javascript console.")})}}},a.remove_iprange=function(b,c){var e=a.network.ipranges[c];d.networks.delete({id:a.network.uuid,controller:"ipranges",controller_id:e},function(){a.network._ipranges.splice(c,1),a.network.ipranges.splice(c,1)})},a.add_iprange=function(b){d.networks.put({id:a.network.uuid,controller:"ipranges",controller_id:b.uuid},function(){a.network.ipranges.push(b.uuid),a.network._ipranges.push(b)})},a.available_ipranges=function(b){return a.network&&a.network.ipranges?b.filter(function(b){return a.network.ipranges.indexOf(b.uuid)<0}):b},a.ipranges=d.ipranges.query(),a.network=d.networks.getFull({id:h}),a.network.$promise.then(function(b){g.setLast(b.name),a.network.ipranges||(a.network.ipranges=[],a.network._ipranges=[])})}]),angular.module("fifoApp").controller("UserCtrl",["$scope","$routeParams","$location","wiggle","vmService","status","breadcrumbs",function(a,b,c,d,e,f,g){var h=b.uuid;a.p2=!1,a.p3=!1;var i=function(){var a={};return function(b,c,e){a[b]||(a[b]={}),a[b][c]?e(a[b][c]):d[b].get({id:c},function(d){a[b][c]=d,e(d)},function(d,e){a[b][c]={id:c,alias:"<b>DELETED</b>"},console.log("Err",d,e)})}}();a.org_join=function(){var b=a.org_to_join;d.users.put({id:h,controller:"orgs",controller_id:b},{},function(){-1==a.user.orgs.indexOf(b)&&(a.user.orgs.push(b),a.user._orgs[b]=a.orgs[b])})},a.org_select=function(){var b=a.user.org;d.users.put({id:h,controller:"orgs",controller_id:b},{active:!0},function(){})},a.org_leave=function(b){d.users.delete({id:h,controller:"orgs",controller_id:b},function(){a.user.orgs.splice(a.user.orgs.indexOf(b),1),delete a.user._orgs[b]})};var j=function(a){var b={text:a.join("->"),obj:a},c=a.slice();if(a[1]&&"..."!=a[1]&&"_"!=a[1])switch(a[0]){case"users":case"roles":case"packages":case"dtraces":case"ipranges":i(a[0],a[1],function(a){c[1]=a.name,b.text=c.join("->")});break;case"datasets":i(a[0],a[1],function(a){a.name&&a.version&&(c[1]=a.name+" ("+a.version+")",b.text=c.join("->"))});break;case"vms":i(a[0],a[1],function(d){d.config&&d.config.alias&&(c[1]=d.config.alias+"("+a[1]+")",b.text=c.join("->"))})}return b
};a.delete_permission=function(b){var c={controller:"permissions",id:a.user.uuid};c.controller_id=b[0],b[1]&&(c.controller_id1=b[1]),b[2]&&(c.controller_id2=b[2]),b[3]&&(c.controller_id3=b[3]),d.users.revoke(c,function(){a.permissions=a.permissions.filter(function(a){return a.obj!=b})})},a.grant=function(){a.permission.id=a.user.uuid,a.permission.controller="permissions",a.show_text&&(a.permission.controller_id3=a.perm_text),d.users.grant(a.permission,function(){var b=[a.permission.controller_id];a.permission.controller_id1&&b.push(a.permission.controller_id1),a.permission.controller_id2&&b.push(a.permission.controller_id2),a.permission.controller_id3&&b.push(a.permission.controller_id3),a.permissions.push(j(b))},function(a){console.log("failed:",a)})},a.perm_change=mk_permission_fn(d,a),a.delete=function(){var b=a.user.name,e=a.user.uuid;a.modal={btnClass:"btn-danger",confirm:"Delete",title:"Confirm VM Deletion",body:'<p><font color="red">Warning!</font> you are about to delete the User <b id="delete-uuid">'+b+" ("+e+") </b> Are you 100% sure you really want to do this?</p><p>Clicking on Delete here will mean this User is gone forever!</p>",ok:function(){d.users.delete({id:e},function(){f.success(b+" deleted"),c.path("/configuration/users")},function(a){console.error("Delete User error:",a),f.error("There was an error deleting your user. See the javascript console.")})}}},a.add_otp=function(){console.log(a.otp)},a.add_otp=function(){var b=a.otp,c=b.slice(0,-32),e=a.user.yubikeys||[];-1==e.indexOf(c)&&d.users.put({id:a.user.uuid,controller:"yubikeys"},{otp:b},function(){e[e.length]=c,a.user.yubikeys=e})},a.delete_yubikey=function(b){d.users.delete({id:a.user.uuid,controller:"yubikeys",controller_id:b},function(){var c=a.user.yubikeys.indexOf(b);c>-1&&a.user.yubikeys.splice(c,1)})},a.passwd=function(){a.pass1==a.pass2?d.users.put({id:a.user.uuid},{password:a.pass1},function(){f.success("Password for user "+a.user.name+" changed.")}):f.error("Passwords don't match!")},a.leave_role=function(b){d.users.delete({id:a.user.uuid,controller:"roles",controller_id:b},function(){a.user.roles=a.user.roles.filter(function(a){return a!=roles}),delete a.user._roles[b]})},a.role_join=function(){d.users.put({id:a.user.uuid,controller:"roles",controller_id:a.role},function(){a.user.roles.push(a.role),a.user._roles[a.role]=a.roles[a.role]})},a.delete_sshkey=function(b){d.users.delete({id:a.user.uuid,controller:"keys",controller_id:b},function(){delete a.user.keys[b]})},a.save_sshkeys=function(){var b=a.ssh_keys,c=b.split(" ")[2],e={};e[c]=b,d.users.put({id:a.user.uuid,controller:"keys"},e,function(){a.user.keys[c]=b,f.success("SSH Key added")},function(a){var b=422===a.status?"SSH public key format not recognized":"Could not save SSH Key";f.error(b),console.log("SSH Key save error:",a)})};var k=function(){a.pass1="",a.pass2="",a.roles={},a.orgs={},d.roles.query(function(b){b.forEach(function(b){a.roles[b.uuid]=b,a.user._roles[b.uuid]&&(a.user._roles[b.uuid]=b)})}),d.orgs.query(function(b){b.forEach(function(b){a.orgs[b.uuid]=b,a.user._orgs[b.uuid]&&(a.user._orgs[b.uuid]=b)})})};d.users.get({id:h},function(b){b.roles=b.roles||[],a.user=b,k(),g.setLast(b.name),a.ssh_keys=a.user.mdata("ssh_keys"),a.permissions=[],a.user._roles={},a.user._orgs={},0==a.user.keys.length&&(a.user.keys={}),a.user.yubikeys||(a.user.yubikeys=[]),a.user.roles.map(function(b){a.user._roles[b]=a.roles[b]?a.roles[b]:{uuid:b,name:"DELETED",deleted:!0}}),a.user.orgs.map(function(b){a.user._orgs[b]=a.orgs[b]?a.orgs[b]:{uuid:b,name:"DELETED",deleted:!0}}),a.permissions=b.permissions.map(j)})}]),angular.module("fifoApp").controller("AboutCtrl",["$scope","wiggle","$http",function(a,b,c){var d={transformRequest:function(a,b){delete b()["x-snarl-token"]}},e="http://release.project-fifo.net/pkg",f="rel";a.latest={},b.cloud.get(function(b){a.versions=b.versions,a.adjustMessage=Config.adjustMessage,c.get("jingles.version").then(function(b){a.versions.jingles=b.data.trim();var g=a.versions.jingles.substr(0,3);("dev"==g||"tes"==g)&&(f="dev"),["sniffle","snarl","howl","wiggle","jingles"].forEach(function(b){c.get(e+"/"+f+"/"+b+".version",d).success(function(c){a.latest[b]=c.trim()})})})}),!function(a,b,c){var d,e=a.getElementsByTagName(b)[0];a.getElementById(c)||(d=a.createElement(b),d.id=c,d.src="//platform.twitter.com/widgets.js",e.parentNode.insertBefore(d,e))}(document,"script","twitter-wjs")}]),angular.module("fifoApp").controller("RoleCtrl",["$scope","$routeParams","$location","wiggle","vmService","status","breadcrumbs",function(a,b,c,d,e,f,g){var h=b.uuid;a.p2=!1,a.p3=!1;var i=function(){var a={};return function(b,c,e){a[b]||(a[b]={}),a[b][c]?e(a[b][c]):d[b]?d[b].get({id:c},function(d){a[b][c]=d,e(d)}):e({uuid:c,name:c})}}(),j=function(a){var b={text:a.join("->"),obj:a},c=a.slice();if(a[1]&&"..."!=a[1]&&"_"!=a[1])switch(a[0]){case"users":case"roles":case"packages":case"dtraces":case"ipranges":i(a[0],a[1],function(a){c[1]=a.name,b.text=c.join("->")});break;case"datasets":i(a[0],a[1],function(a){a.name&&a.version&&(c[1]=a.name+" ("+a.version+")",b.text=c.join("->"))});break;case"vms":i(a[0],a[1],function(d){d.config&&d.config.alias&&(c[1]=d.config.alias+"("+a[1]+")",b.text=c.join("->"))})}return b};d.roles.get({id:h},function(b){a.role=b,a.permissions=b.permissions.map(j),console.log(a.permissions),g.setLast(b.name)}),a.delete_permission=function(b){var c={controller:"permissions",id:a.role.uuid};c.controller_id=b[0],b[1]&&(c.controller_id1=b[1]),b[2]&&(c.controller_id2=b[2]),b[3]&&(c.controller_id3=b[3]),d.roles.revoke(c,function(){a.permissions=a.permissions.filter(function(a){return a.obj!=b})})},a.grant=function(){a.permission.id=a.role.uuid,a.permission.controller="permissions",a.show_text&&(a.permission.controller_id3=a.perm_text),d.roles.grant(a.permission,function(){var b=[a.permission.controller_id];a.permission.controller_id1&&b.push(a.permission.controller_id1),a.permission.controller_id2&&b.push(a.permission.controller_id2),a.permission.controller_id3&&b.push(a.permission.controller_id3),a.permissions.push(j(b))},function(a){console.log("Grant failed:",a)})},a.perm_change=a.perm_change=mk_permission_fn(d,a),a.delete=function(){var b=a.role.name,e=a.role.uuid;a.modal={btnClass:"btn-danger",confirm:"Delete",title:"Confirm VM Deletion",body:'<p><font color="red">Warning!</font> you are about to delete the Role <b id="delete-uuid">'+b+" ("+e+") </b> Are you 100% sure you really want to do this?</p><p>Clicking on Delete here will mean this Role is gone forever!</p>",ok:function(){d.roles.delete({id:e},function(){f.success(b+" deleted"),c.path("/configuration/roles")},function(a){console.error("Delete Role error:",a),f.error("There was an error deleting your role. See the javascript console.")})}}}}]),angular.module("fifoApp").controller("OrganizationCtrl",["$scope","$routeParams","$location","wiggle","vmService","status","breadcrumbs",function(a,b,c,d,e,f,g){a.role="",a.permission="",a.grant_triggers={},a.join_triggers={};var h=b.uuid;a.roles={},d.roles.query(function(b){b.forEach(function(b){a.roles[b.uuid]=b})}),a.orgs={},d.orgs.query(function(b){b.forEach(function(b){a.orgs[b.uuid]=b})}),d.orgs.get({id:h},function(b){g.setLast(b.name),init_scope(a,b)}),a.add_grant_trigger=function(){var b,c=a.created_object;if("vm_create"==c)b="vms";else{if("dataset_create"!=c)return void console.error("No target selected");b="datasets"}d.orgs.create({id:h,controller:"triggers",controller_id:c},{action:"role_grant",base:b,permission:[a.permission],target:a.grant_role},function(b){init_scope(a,b)})},a.delete_grant_trigger=function(b){{var c=b.permission.splice(0);b.target,c.shift()}c.shift(),d.orgs.delete({id:a.org.uuid,controller:"triggers",controller_id:b.uuid},{},function(){d.orgs.get({id:h},function(b){init_scope(a,b)})})},a.add_role_join_trigger=function(){d.orgs.create({id:h,controller:"triggers",controller_id:"user_create"},{action:"join_role",target:a.join_role},function(b){init_scope(a,b)})},a.add_org_join_trigger=function(){d.orgs.create({id:h,controller:"triggers",controller_id:"user_create"},{action:"join_org",target:a.join_org},function(b){init_scope(a,b)})},a.delete_join_trigger=function(b){d.orgs.delete({id:a.org.uuid,controller:"triggers",controller_id:b.uuid},{},function(){d.orgs.get({id:h},function(b){init_scope(a,b)})})},a.delete=function(){var b=a.org.name,e=a.org.uuid;a.modal={btnClass:"btn-danger",confirm:"Delete",title:"Confirm VM Deletion",body:'<p><font color="red">Warning!</font> you are about to delete the Org <b id="delete-uuid">'+b+" ("+e+") </b> Are you 100% sure you really want to do this?</p><p>Clicking on Delete here will mean this Org is gone forever!</p>",ok:function(){d.orgs.delete({id:e},function(){f.success(b+" deleted"),c.path("/configuration/organizations")},function(a){console.error("Delete Org error:",a),f.error("There was an error deleting your org. See the javascript console.")})}}}}]);var renderer;angular.module("fifoApp").controller("DtraceCtrl",["$scope","$routeParams","$location","wiggle","status","breadcrumbs",function(a,b,c,d,e,f){var g=b.uuid,h=!1;a.running=!1;var i=function(a){return a.map(function(a){return"string"!=typeof a?a:(a.value.match(/^\d+$/)?a.value=parseInt(a.value):"true"==a.value?a.value=!0:"false"==a.value?a.value=!1:"null"==a.value&&(a.value=null),a)})};a.hypervisors=d.hypervisors.query(),a.vms=d.vms.query(),d.dtrace.get({id:g},function(b){b.cur_vars=[],b.vars=[];for(var c in b.config)b.cur_vars.push({name:c,value:b.config[c]}),b.vars.push({name:c,value:b.config[c]});a.script=b,f.setLast(b.name)}),a.$on("$destroy",function(){h&&h.close()}),a.sel_hyps=[],a.sel_vms=[],a.start=function(){if(renderer)return a.running=!0,void renderer.start();if(0==a.sel_hyps.length&&0==a.sel_vms.length)return void e.error("You must select at least one hypervisor or one VM!");"MozWebSocket"in window&&(WebSocket=MozWebSocket);var b=Config.wsUrl+Config.apiPath+"/dtrace/"+g+"/stream";h=new WebSocket(b,"msgpack"),h.binaryType="arraybuffer",h.onmessage=function(b){var b=msgpack.unpack(new Uint8Array(b.data));if(b.config)switch(b.config.type){case"heatmap":default:a.$apply(function(){a.running=!0}),renderer=new Heatmap("#content",b.config)}else renderer&&renderer.render(b)},h.onopen=function(){var b={};i(a.script.cur_vars).forEach(function(a){"string"!=typeof a.value||(a.value.match(/^\d+$/)?a.value=parseInt(a.value):"true"==a.value?a.value=!0:"false"==a.value?a.value=!1:"null"==a.value&&(a.value=null)),b[a.name]=a.value});var c={config:b,servers:a.sel_hyps,vms:a.sel_vms},d=new Uint8Array(msgpack.pack(c));h.send(d.buffer)}},a.pause=function(){renderer&&(a.running=!1,renderer.stop())},a.stop=function(){h&&(a.running=!1,renderer=void 0,h.close(),h=!1)}}]),angular.module("fifoApp").factory("auth",["$rootScope","wiggle","$location","$route","$http","$cookies","howl","$q",function(a,b,c,d,e,f,g,h){function i(a,b){for(var c=!0,d=0;d<a.length;d++){var e=b[d],f=a[d];if("..."==e)return!0;if("_"!=e&&e!=f){c=!1;break}}return c}function j(){if(!m.isLogged()){k=new b.users({status:"waiting for login validation"});var c=f["x-snarl-token"];if(!c)return a.$broadcast("auth:login_needed");b.sessions.get({id:c}).$promise.then(function(c){k=new b.users(c),a.$broadcast("auth:login_ok",k,c.data)},function(){a.$broadcast("auth:login_needed")})}}var k,l=h.defer(),m={canAccess:function(a){if(!k)return!1;var b=k.permissions||[];Object.keys(k._roles).forEach(function(a){b=b.concat(k._roles[a].permissions)});for(var c=0;c<b.length;c++)if(i(a,b[c]))return!0;return!1},currentUser:function(){return k},isLogged:function(){return!!k},userPromise:function(){return l.promise},login:function(d,e,g){var h={user:d,password:e};g&&(h.otp=g),b.sessions.login(null,h).$promise.then(function(d){k=new b.users(d),k.keys=k.keys||[],k.roles=k.roles||[],f["x-snarl-token"]=d.session,a.$broadcast("auth:login_ok",k,d.session),c.path("/")},function(b){a.$broadcast("auth:login_error",b)})},logout:function(){k=null;var d=f["x-snarl-token"];d&&(b.sessions.delete({id:d}),delete f["x-snarl-token"]),a.$broadcast("auth:logout"),c.path("/login")}};return a.$on("$routeChangeSuccess",function(){j()}),a.$on("auth:login_needed",function(){"/login"!=c&&m.logout()}),a.$on("auth:login_ok",function(){l.resolve(k),b.setUp(),"WebSocket"in window&&(b.vms.list(g.join),b.hypervisors.list(g.join),g.connect(f["x-snarl-token"]))}),j(),m}]),angular.module("fifoApp").controller("LoginCtrl",["$scope","auth","$timeout","wiggle","$location",function(a,b,c,d){a.submit=function(){$("form input").each(function(){$(this).trigger("input")}),b.login(a.user,a.password,a.otp)},a.$on("auth:login_ok",function(){a.password=null}),a.$on("auth:login_error",function(b,d){a.loginError=d.data?d.data+" ("+d.status+")":"Error "+d.status,c(function(){a.loginError=!1},4e3)}),a.connectionStatus={msg:"Connecting..."};var e=function(){var b=a.connectionStatus.ok?15e3:5e3;a.poller=c(f,b)},f=function(){d.cloud.get({controller:"connection"},function(b){a.connectionStatus.ok=b.howl>0&&b.snarl>0&&b.sniffle>0,a.connectionStatus.msg="Not connected to: ",Object.keys(b).forEach(function(c){0===b[c]&&(a.connectionStatus.msg+=c+" ")}),e()},function(){a.connectionStatus.ok=!1,a.connectionStatus.msg="No connection",e()})};f(),a.$on("$destroy",function(){c.cancel(a.poller)})}]),angular.module("fifoApp").controller("MachineNewCtrl",["$scope","wiggle","$location","status","auth","$q",function(a,b,c,d,e,f){a.create_machine=function(){if(a.selectedNetworks.length!=a.selectedDataset.networks.length)return void d.error("Your network selection is invalid. You have either too many or too few networks selected.");a.server&&a.rules.push({weight:"must",attribute:"uuid",condition:"=:=",value:a.server.uuid});var e={"package":a.selectedPackage.uuid,dataset:a.selectedDataset.dataset,config:{networks:{},metadata:{},alias:a.alias,hostname:a.hostname,ssh_keys:a.ssh_keys,requirements:a.rules,autoboot:a.autoboot}};a.passwords.forEach(function(a){a.pass&&(e.config[a.name+"_pw"]=a.pass)});for(var g=0;g<a.selectedNetworks.length;g++)e.config.networks["net"+g]=a.selectedNetworks[g].uuid;a.resolver1&&(e.config.resolvers=[a.resolver1]),a.resolver2&&e.config.resolvers.push(a.resolver2),a.userScript&&(e.config.metadata["user-script"]=a.userScript),a.metadata.forEach(function(a){e.config.metadata[a.key]=a.value});var h=a.alias.match(/\{(\d+)-(\d+)\}/);if(h){for(var i=Math.min(h[1],h[2]),j=Math.max(h[1],h[2]),k=[],g=i;j>=g;g++){var l=new b.vms(angular.copy(e));l.config.alias=e.config.alias.replace(h[0],g),l.config.hostname=l.config.alias,k.push(l.$save())}f.all(k).then(function(a){a.forEach(function(a){howl.join(a.uuid)}),c.path("/machines")},function(a){console.error("Create VMs error:",a),d.error("There was an error creating your VMs. See their logs or js console for details.")})}else new b.vms(e).$save().then(function(a){howl.join(a.uuid),c.path("/machines")},function(){console.error("Create VM error:",res),d.error("There was an error creating your VM. See its logs or js console for details.")})},a.click_package=function(b){a.selectedPackage=b},a.click_dataset=function(b){(!a.alias||a.selectedDataset&&a.alias==a.selectedDataset.name)&&(a.alias=b.name),a.selectedDataset=b,a.passwords=b.users||[{name:"root"},{name:"admin"}]},a.click_network=function(b){var c=a.selectedNetworks.indexOf(b);return c>-1?a.selectedNetworks.splice(c,1):(a.selectedNetworks.length>=a.selectedDataset.networks.length&&a.selectedNetworks.splice(c,1),void a.selectedNetworks.push(b))},a.metadata=[],a.meta_action=function(b,c){switch(b){case"delete":a.metadata.splice(c,1);break;case"create":d.prompt("Enter metadata key:",function(b){a.metadata.push({key:b}),a.$apply()})}},a.init=function(){a.datasets=[],a.packages=[],a.networks=[],a.rules=[{}],a.autoboot=!0,a.user=e.currentUser(),a.latestDatasets={},b.datasets.query(function(b){return b.length<1?(d.error("Import a dataset first"),c.path("/datasets")):void b.forEach(function(b){1==b.imported&&((!a.latestDatasets[b.name]||a.latestDatasets[b.name]<b.version)&&(a.latestDatasets[b.name]=b.version),a.datasets.push(b))})}),b.packages.query(function(b){return b.length<1?(d.error("Please create a package"),c.path("/configuration/packages/new")):(a.packages=b,void(a.selectedPackage=b[0]))}),b.networks.query(function(b){return b.length<1?(d.error("Please create a network"),c.path("/configuration/networks/new")):(b.forEach(function(b){!b.ipranges||b.ipranges.length<1||a.networks.push(b)}),a.networks.length<1?(d.error("Please setup a network with an iprange"),c.path("/configuration/networks")):void(a.selectedNetworks=[a.networks[0]]))}),a.servers=b.hypervisors.query(),a.$watch("alias",function(b,c){a.hostname&&a.hostname!=c||(a.hostname=b)})},a.init()}]),angular.module("fifoApp").controller("PackageNewCtrl",["$scope","wiggle","$location","status","utils",function(a,b,c,d){a.create_package=function(){if(a.rules===!1)return void d.error("Some rules are not valid. Please fix them");var e=new b.packages({name:a.name,quota:parseInt(a.quota),ram:parseInt(a.ram),cpu_cap:parseInt(a.cpu_cap),requirements:a.rules}),f=parseInt(a.io,10);f&&(e.zfs_io_priority=f),e.$create({},function(){c.path("/configuration/packages")},function(a){console.error("Create Package error:",a),d.error("There was an error creating your package. See the javascript console.")})},a.rules}]),angular.module("fifoApp").controller("NetworkNewCtrl",["$scope","wiggle","$location","status",function(a,b,c,d){a.create_network=function(){var e=new b.networks({name:a.name});e.$create({},function(){c.path("/configuration/networks")},function(a){switch(a.status){case 409:d.error("A network with this name already exists!");break;default:console.error("Create Network error:",a),d.error("There was an error creating your network. See the javascript console.")}})}}]),angular.module("fifoApp").controller("IpRangeNewCtrl",["$scope","wiggle","$location","status",function(a,b,c,d){function e(a){var b=a.split(".").map(function(a){return parseInt(a)}),c=(b[0]<<24)+(b[1]<<16)+(b[2]<<8)+b[3];return c}a.rules=[{}],a.create_iprange=function(){var f=e(a.netmask),g=e(a.network),h=e(a.gateway),i=e(a.first),j=e(a.last),k=g+~f;if((g&f)!=g)return d.error("Iprange / Netmask combination is not valid!"),1;if((h&f)!=g||h==g)return d.error("Gateway is not in the iprange range!"),1;if((i&f)!=g||i==g)return d.error("First is not in the iprange range!"),1;if((j&f)!=g||j==g)return d.error("Last is not in the iprange range!"),1;if(i>j)return d.error("First has to be lower or equal to last!"),1;if(h>=i&&j>=h)return d.error("The gateway is in between first and last, this can't work!"),1;if(h==k)return d.error("The gateway equals the ipranges broadcast!"),1;if(j==k)return d.error("The last equals the ipranges broadcast!"),1;var l=new b.ipranges({name:a.name,tag:a.tag||0,network:a.network,netmask:a.netmask,gateway:a.gateway,first:a.first,last:a.last});a.vlan&&(l.vlan=parseInt(a.vlan,10)),l.$create({},function(){c.path("/configuration/ip-ranges")},function(a){switch(a.status){case 409:d.error("A iprange with this name already exists!");break;default:console.error("Create Iprange error:",a),d.error("There was an error creating your iprange. See the javascript console.")}})},a.iprange_tags=[],b.hypervisors.query(function(b){b.forEach(function(b){b.networks&&b.networks.forEach(function(b){a.iprange_tags.indexOf(b)<0&&a.iprange_tags.push(b)})})})}]),angular.module("fifoApp").controller("UserNewCtrl",["$scope","wiggle","$location","status",function(a,b,c,d){a.create_user=function(){var e=new b.users({user:a.name,password:a.pass1});e.$create({},function(){c.path("/configuration/users_roles")},function(){console.error("Create Package error:",data),d.error("There was an error creating your package. See the javascript console.")})}}]),angular.module("fifoApp").controller("RoleNewCtrl",["$scope","$location","wiggle","status",function(a,b,c,d){a.create_role=function(){var e=new c.roles({name:a.name});e.$create({},function(){b.path("/configuration/roles")},function(){console.error("Create Package error:",data),d.error("There was an error creating your package. See the javascript console.")})}}]),angular.module("fifoApp").controller("OrganizationNewCtrl",["$scope","$location","status","wiggle",function(a,b,c,d){a.create_org=function(){var e=new d.orgs({name:a.name});e.$create({},function(){b.path("/configuration/organizations")},function(){console.error("Create Package error:",data),c.error("There was an error creating your package. See the javascript console.")})}}]),angular.module("fifoApp").controller("DtraceNewCtrl",["$scope","$location","wiggle","status",function(a,b,c,d){function e(a,b){var c=a.match(/\$\w+\$/g);if(!c)return b;var d=c.map(function(a){return a.replace(/\$/g,"")}).filter(function(a){return-1==h.indexOf(a)});return d.forEach(function(a){var c=!1;b.forEach(function(b){c=c||b.name==a}),c||b.push({name:a})}),b.filter(function(a){var b=d.indexOf(a.name)>=0||void 0!=a.value;return b})}a.add_var=function(){a.variables.push({})},a.rm_var=function(b){a.variables.splice(b,1)};var f=function(a){var b=!0;return a.forEach(function(a){var c=!a.value&&!a.name;c||void 0!=a.value&&void 0!=a.name&&a.name.match(/^\w+$/)||(b=!1)}),b},g=function(a){return a.map(function(a){return"string"!=typeof a.value?a:(a.value.match(/^\d+$/)?a.value=parseInt(a.value):"true"==a.value?a.value=!0:"false"==a.value?a.value=!1:"null"==a.value&&(a.value=null),a)})},h=["filter","partial_filter"];a.$watch("script",function(b){b&&(a.variables=e(a.script,a.variables))}),a.create_dtrace=function(){var e=g(a.variables);if(!f(e))return void d.error("Some variables are not valid. Please fix them");var h={};e.forEach(function(a){void 0!=a.name&&void 0!=a.value&&(h[a.name]=a.value)});var i=new c.dtrace({name:a.name,script:a.script,config:h});i.$create({},function(){d.success("Script "+a.name+" created"),b.path("/configuration/dtraces")},function(a){console.error("Create Dtrace error:",a),d.error("There was an error creating your dtrace. See the javascript console.")})},a.init=function(){a.variables=[]},a.init()}]),angular.module("fifoApp").controller("VisGraphCtrl",["$scope","wiggle","auth","$filter","status",function(a,b,c,d){var e=function(){a.zoomValue=d3.event.scale,a.$digest(),C.attr("transform"," translate("+d3.event.translate+") scale("+d3.event.scale+")")};a.$watch("zoomValue",function(a){C.attr("transform","scale("+a+")")}),a.distanceValue=100,a.$watch("distanceValue",function(){D.linkDistance(B).start()}),a.chargeValue=.1,a.$watch("chargeValue",function(){D.charge(p).start()}),a.elasticityValue=.15,a.$watch("elasticityValue",function(a){D.linkStrength(1-a).start()}),a.reset=function(){document.querySelector("#zoomBar").value=1,C.attr("transform","translate(0,0)"),a.distanceValue=100,a.zoomValue=1,a.chargeValue=.1,a.elasticityValue=.15};var f=function(a,b){b=b||{w:"100%",h:"100%"},b.margin=b.margin||{},b.margin.w=b.margin.w||0,b.margin.h=b.margin.w||0;var c=d3.select(a).append("svg").attr("width",b.w).attr("height",b.h).call(d3.behavior.zoom().on("zoom",e)).append("g").attr("transform","translate("+b.margin.w+","+b.margin.h+")");return document.canvas=c,c},g=function(){a.vmsNodes=(a.vmsNodes||C.selectAll("g.vm")).data(d3.values(a.vmsHash),function(a){return a.uuid});var b=a.vmsNodes.enter().append("g").attr("class","vm").attr("opacity",function(a){return"running"==a.state?1:.3}).call(D.drag).on("mouseover",function(b){a.vm=b,a.$digest(),angular.element("#popover_vm").css("left",210+b.x+"px"),angular.element("#popover_vm").css("top",-30+b.y+"px")}).on("mouseout",function(){a.vm=void 0,a.$digest()}).on("click",function(a){d3.event.defaultPrevented||window.open("#/machines/"+a.uuid,"_blank")}),c=30;b.append("circle").attr("class","cpu").attr("r",c/2).attr("fill","red").attr("fill-opacity",0),b.append("image").attr("xlink:href",function(a){return"images/logos/"+(a.config._dataset&&a.config._dataset.os||"unknown")+".png"}).attr("width",c).attr("height",c).attr("x",-c/2).attr("y",-c/2),b.append("text").attr("class","ram").text(function(a){return F(a.config.ram)}),b.call(l({fill:"rgb(255, 178, 39)",width:c,height:5})),a.vmsNodes.call(q)},h=60,i=Config.could_test.filter(function(a){return"memory"==a.element?a:void 0}).pop().max,j=function(a){return a>i?"red":"rgb(255, 178, 39)"},k=function(){a.hypersNodes=(a.hypersNodes||C.selectAll("g.hyper")).data(d3.values(a.hypersHash),function(a){return a.alias});var b=a.hypersNodes.enter().append("g").attr("class","hyper").call(D.drag).on("mouseover",function(b){a.hyper=b,a.$digest(),angular.element("#popover_hyper").css("left",210+b.x+"px"),angular.element("#popover_hyper").css("top",-30+b.y+"px")}).on("mouseout",function(){a.hyper=void 0,a.$digest()}).on("click",function(a){d3.event.defaultPrevented||window.open("#/servers/"+a.uuid,"_blank")}),c=d3.min(d3.values(a.hypersHash),function(a){return a.resources["total-memory"]}),d=d3.max(d3.values(a.hypersHash),function(a){return a.resources["total-memory"]});c==d&&(c=8e3);var e=d3.scale.sqrt().domain([c,d]).range([25,60]);b.append("image").attr("xlink:href","images/server.png").attr({width:function(a){return e(a.resources["total-memory"])},height:function(a){return e(a.resources["total-memory"])},transform:function(a){var b=e(a.resources["total-memory"])/2;return"translate("+-b+","+-b+")"}});var f=3*h/4;b.call(l({border:"rgb(114, 74, 0)",fill:function(a){return j(a.resources["provisioned-memory"]/a.resources["total-memory"])},width:f,progress:function(a){return a.resources["provisioned-memory"]/a.resources["total-memory"]}})),b.append("text").attr("y",h/2).attr("text-anchor","middle").text(function(a){return a.alias}),b.append("text").attr("class","ram").attr("y",-5).attr("text-anchor","middle").text(function(a){return F(a.resources["total-memory"])})},l=function(a){return a.width=a.width||20,a.x=a.x||-a.width/2,a.y=a.y||11,a.height=a.height||5,function(b){b.append("rect").attr({"class":"progress",fill:a.fill||"green",height:a.height,width:function(b){if(!a.progress)return 0;if("number"==typeof a.progress)return a.progress*a.width;var c=a.progress(b);return c*a.width},x:a.x,y:a.y}),a.border&&b.append("rect").attr({"class":"progress-border",fill:"none",stroke:a.border||"black","stroke-width":a["stroke-width"]||1,height:a.height,width:a.width,x:a.x,y:a.y})}},m=function(b){a.links=(a.links||C.selectAll("line.link")).data(d3.values(b),function(a){return a.target.uuid}),a.links.enter().insert("line",".hyper").attr("class","link").attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}).attr("stroke","rgba(114, 144, 160, 0.4)").attr("stroke-width",function(a){return a.target.config?1:0})},n=function(){var b=[],c=[],d={};d3.values(a.hypersHash).forEach(function(a,e){d[a.uuid]=e,c.forEach(function(a){b.push({source:e,target:d[a.uuid]})}),c.push(a)}),d3.values(a.vmsHash).forEach(function(a){c.push(a);var e=d[a.hypervisor];"number"==typeof e?b.push({source:e,target:c.length-1}):console.log("WARN: no hidx for "+a.hypervisor)}),D.nodes(c).links(b).start(),b.forEach(function(b){a.linksHash[b.target.uuid]=b}),m(a.linksHash),E()},o=function(){b.hypervisors.list(function(d){var e=d.length,f=function(b){b&&(a.hypersHash[b.uuid]=b),--e<1&&c()};d.forEach(function(a){b.hypervisors.get({id:a},f,f)})});var c=function(){b.vms.list(function(c){var e=c.length,f=function(b){b&&(a.vmsHash[b.uuid]=b),--e<1&&d()};c.forEach(function(a){b.vms.get({id:a},f,f)})})},d=function(){var b=d3.extent(d3.values(a.vmsHash),function(a){return a.config.ram});a.vmScale=d3.scale.sqrt().domain(b).range([25,40]),k(),g(),d3.values(a.vmsHash).forEach(function(a){howl.join(a.uuid+"-metrics")}),n()}},p=function(b){var c;return c=b.port?.02*-b.resources["total-memory"]:-b.config.ram*a.chargeValue},q=function(b){var c=1500;b.each(function(b){b._logoSize=a.vmScale(b.config.ram)}),b.select("text.ram").transition().duration(c).attr("x",function(a){return 2*a._logoSize/5}).attr("y",function(a){return-a._logoSize/5}).text(function(a){return F(a.config.ram)}),b.select("image").transition().duration(c).attr("width",function(a){return a._logoSize}).attr("height",function(a){return a._logoSize}).attr("x",function(a){return-a._logoSize/2}).attr("y",function(a){return-a._logoSize/2}),b.select("circle.cpu").transition().duration(c).attr("r",function(a){return a._logoSize/2.5}),b.select("rect.progress").transition().duration(c).attr("y",function(a){return 2*a._logoSize/5}),b.select("circle.highlight").transition().duration(c).attr("r",function(a){return a._logoSize/2}),D.charge(p).start()},r=function(b,c){var d=c.message.data;d.uuid=c.channel;var e=a.vmsHash[d.uuid];$.extend(!0,e,d);var f=a.vmsNodes.data([e],function(a){return a.uuid});f.call(q),f.append("circle").attr("r",8).attr("stroke","green").attr("fill","none").transition().duration(1500).attr("r",30).style("stroke-opacity",0).style("stroke-width",5).remove()},s=function(b,c){var d=a.vmsHash[c.channel];d.state=c.message.data,a.vmsNodes.data([d],function(a){return a.uuid}).transition().attr("opacity","running"==d.state?1:.3)},t=d3.scale.linear().domain([20,100]).range([0,.85]),u=function(b,c){var d=c.channel.split("-metrics")[0],e=a.vmsHash[d];a.vmsNodes.data([e],function(a){return a.uuid}).select("circle.cpu").transition().attr("fill-opacity",t(c.message.data.usage))},v=function(b,c){var d=c.channel.split("-metrics")[0],e=a.vmsHash[d],f=c.message.data.rss/c.message.data.physcap;a.vmsNodes.data([e],function(a){return a.uuid}).select("rect.progress").transition().attr("width",function(a){return f*a._logoSize}).attr("x",function(a){return-f*a._logoSize/2})},w=d3.scale.linear().domain([2048,2048]).range([1,7]),x=2048,y=function(b,c){var e=c.channel.split("-metrics")[0],f=a.linksHash[e],g=c.message.data;if(!f)return console.log("ug, no link.. :(");f.target.netActivity=f.target.netActivity||{};var h=f.target.netActivity,i=g.obytes64+g.rbytes64,j=h[g.ifname];f.target.netActivity[g.ifname]=i;{var k=i-j;d("bytes")(k)}k>x&&(x=k,w.domain([2048,x])),a.links.data([f],function(a){return a.target.uuid}).transition().attr("stroke-width",k>2048?w(k):1).attr("stroke",k>2048?"blue":"rgba(114, 144, 160, 0.4)")},z=function(b,c){var d=c.channel;delete a.vmsHash[d];var e=a.vmsNodes.data(d3.values(a.vmsHash),function(a){return a.uuid}).exit();delete a.linksHash[d],a.links.data(d3.values(a.linksHash),function(a){return a.target.uuid}).exit().remove(),e.append("circle").attr("class","highlight").attr("r",40).attr("stroke","red").attr("fill","none").transition().duration(1e3).attr("r",8).style("stroke-opacity",0).style("stroke-width",5).remove(),e.transition().delay(1e3).remove()},A=function(b,c){var d=c.channel,e=c.message.data,f=a.hypersHash[d],g=e.provisioned/(e.provisioned+e.free);a.hypersNodes.data([f],function(a){return a.alias}).select(".progress").transition().attr("width",g*h*3/4).attr("fill",j(g))},B=function(b){return b.target.config?a.distanceValue:150},C=f("#container",{w:$("#container").width(),h:$("#container").height()}),D=d3.layout.force().charge(p).linkDistance(B).linkStrength(.85).on("tick",function(){a.vmsNodes&&(a.vmsNodes.attr("transform",function(a){return"translate("+a.x+","+a.y+")"}),a.hypersNodes.attr("transform",function(a){return"translate("+a.x+","+a.y+")"}),a.links.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}))}),E=function(){D&&D.size([$("svg").width(),$("svg").height()]).start()};$(window).resize(E),a.hypersHash={},a.vmsHash={},a.linksHash={},a.$on("user_login",o),c.isLogged()&&o();var F=d("Mbytes");a.$on("update",r),a.$on("state",s),a.$on("cpu",u),a.$on("memstat",v),a.$on("net",y),a.$on("delete",z),a.$on("memorychange",A),a.$on("$destroy",function(){d3.values(a.vmsHash).forEach(function(a){howl.leave(a.uuid+"-metrics")}),H&&clearInterval(H)});var G=function(){b.vms.list(function(c){c.forEach(function(c){a.vmsHash[c]||b.vms.get({id:c},function(b){a.vmsHash[c]=b,g(),n(),howl.join(c),howl.join(c+"-metrics")
})})})},H=Config.newVmPolling&&setInterval(G,1e3*Config.newVmPolling),I=function(){document.getElementById("fullscreen").onclick=function(){var a=function(a){a.requestFullScreen?a.requestFullScreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullScreen&&a.webkitRequestFullScreen()},b=function(){document.cancelFullScreen?document.cancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen()},c=document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement;c?b():a(document.getElementById("container"))}};setTimeout(I,0)}]),angular.module("fifoApp").directive("rule",function(){return{templateUrl:"views/partials/rules.html",restrict:"AE",require:["^ngModel"],replace:!0,scope:{validRules:"=ngModel"},controller:["$scope","utils",function(a,b){a.attributeOptions=["resources.free-memory","resources.total-memory","resources.provisioned-memory","resources.free","resources.size","resources.used","pools.zones.free","health","networks","alias","uuid","virtualisation","resources.l1hits","resources.l1miss","resources.l1size"],a.weightOptions=[{group:"Condition",value:"must"},{group:"Condition",value:"cant"},{group:"Special",value:"scale"},{group:"Special",value:"random"}];for(var c=1;10>c;c++)a.weightOptions.push({group:"Priority",value:c});for(var c=1;10>c;c++)a.weightOptions.push({group:"Priority",value:10*c});for(var c=1;10>c;c++)a.weightOptions.push({group:"Priority",value:-c});for(var c=1;10>c;c++)a.weightOptions.push({group:"Priority",value:-10*c});a.conditionOptions=[">=",">","=<","<","=:=","=/=","subset","superset","disjoint","element"],a.add_rule=function(){a.rules.push({})},a.rm_rule=function(b){a.rules.splice(b,1)},a.validateRules=function(a){var b=!0;return a.forEach(function(a){a.error=!1;var c=!(a.attribute||a.condition||a.weight||a.value);if(!c){if(!a.weight)return b=!1,a.error=!0,!1;switch(a.weight.value){case"scale":a.attribute&&"number"==typeof a.low&&"number"==typeof a.high||(b=!1,a.error=!0);break;case"random":("number"!=typeof a.low||"number"!=typeof a.high)&&(b=!1,a.error=!0);break;default:a.condition&&a.attribute&&a.value||(b=!1,a.error=!0)}}}),b},a.getProcessedRules=function(a){return a.filter(function(a){return a.weight}).map(function(a){var c={weight:a.weight.value};switch(c.weight){case"scale":c.attribute=a.attribute,c.low=a.low,c.high=a.high;break;case"random":c.low=a.low,c.high=a.high;break;default:c.value=b.deserialize(a.value),c.attribute=a.attribute,c.condition=a.condition}return c})},a.rules=[{}]}],link:function(a){a.$watch("rules",function(b){var c=a.validateRules(b);a.validRules=c?a.getProcessedRules(b):!1},!0)}}});var x=[];Heatmap.prototype.start=function(){this.play=!0},Heatmap.prototype.stop=function(){this.play=!1},Heatmap.prototype.render=function(a){if(this.play){var b=this.h,c=this.w,d=this.bucket_count,e=this.bucket_size,f={},g=[],h=[],i=0,j=function(a){var b=0;return a.forEach(function(a){b+=a[1]}),b};for(var k in a)for(var l in a[k]){var m=a[k][l],n=l.split("-")[0];f[n]?f[n].push([k,m]):f[n]=[[k,m]]}for(l in f)g.push([parseInt(l),j(f[l]),f[l]]);if(g.forEach(function(a){var b=a[1];b>i&&(i=b)}),h=g.map(function(a,b){var c=a.slice();return c.unshift(b),c}),h.length){var o=d3.scale.sqrt().domain([0,i]).range(["white","blue"]),p=this.cols.shift();p.svg&&p.svg.remove();var q=d3.select(this.target).append("svg").attr("width",c).attr("height",b*d+100),r=q.selectAll(".rect").data(h).enter().append("svg:rect").attr("width",c).attr("height",b).attr("x",function(){return 0}).attr("y",function(a){return b*d+100-(a[1]/e*b+50)}).style("fill",function(a){return o(a[2])});$(r[0]).tooltip({html:!0,title:function(){var a=this.__data__[1],b=this.__data__[2],c=this.__data__[3];return c=c.reduce(function(a,b){return a+"<br/><b>"+b[0]+"</b>: "+b[1]},""),"Bucket["+a+"]: <b>"+b+"</b>"+c}}),this.cols.push({svg:q,data:h})}}};